<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI SEO Blog Post Generator | AI 기반 SEO 콘텐츠 생성기</title>
    <meta name="description" content="고품질의 SEO 최적화 블로그 포스트를 몇 초 만에 생성하세요. 고급 AI 모델과 실시간 트렌드 분석을 활용합니다.">
    <!-- Bootstrap CSS & Icons (Keep for grid/utilities, but override styles) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- 새로운 모듈화된 CSS 시스템 -->
    <link rel="stylesheet" href="/static/css/main.css">
    <!-- 기존 스타일 호환성 유지 -->
    <link rel="stylesheet" href="/static/sanity_style.css">
    <link rel="stylesheet" href="/static/common.css">
    <link rel="stylesheet" href="/static/wizard.css">
    
    <!-- 모듈화된 JavaScript (ES6 모듈) -->
    <script type="module" src="/static/js/main.js" defer></script>
</head>

<body>
    <!-- Navbar -->
    {% include '_navbar.html' %}

    <!-- Main Content -->
    <div class="container-custom">
        <!-- Hero Section -->
        <section class="hero-section" aria-labelledby="hero-title">
            <h1 id="hero-title" class="hero-title">
                <span class="text-gradient">AI 기반 SEO 콘텐츠 생성기</span>
            </h1>
            <p class="hero-subtitle">
                고품질의 SEO 최적화 블로그 포스트를 몇 초 만에 생성하세요.
            </p>
        </section>

        <!-- Generator Form -->
        {% include 'components/_generator_form.html' %}
        
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Progress -->
                {% include 'components/_progress_bar.html' %}

                <!-- Results -->
                {% include 'components/_result_display.html' %}
                
                <!-- Generator Card (Legacy - will be removed) -->
                <div class="card-custom mb-5">
                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <h2 class="section-title mb-0">새 포스트 작성</h2>
                        <span class="badge-custom">AI Powered</span>
                    </div>

                    <!-- SEO Options -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <label class="form-label-custom">SEO 최적화</label>
                            <div class="d-flex flex-column gap-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="rules" value="AI_SEO"
                                        id="ai_seo">
                                    <label class="form-check-label" for="ai_seo">AI SEO (구조화된 데이터)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="rules" value="AI_SEARCH"
                                        id="ai_search">
                                    <label class="form-check-label" for="ai_search">AI 검색 (의도 분석)</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-custom">AI 최적화</label>
                            <div class="d-flex flex-column gap-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="rules" value="AEO" id="aeo">
                                    <label class="form-check-label" for="aeo">AEO (답변 엔진)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="rules" value="GEO" id="geo">
                                    <label class="form-check-label" for="geo">GEO (생성형 엔진)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="rules" value="AIO" id="aio">
                                    <label class="form-check-label" for="aio">AIO (AI 통합)</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Settings -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <label for="ai_mode" class="form-label-custom">콘텐츠 스타일</label>
                            <select class="form-control-custom" name="ai_mode" id="ai_mode">
                                <option value="">기본</option>
                                <option value="뉴스">뉴스 (객관적)</option>
                                <option value="리뷰">리뷰 (경험적)</option>
                                <option value="가이드">가이드 (단계별)</option>
                                <option value="요약">요약 (간결함)</option>
                                <option value="블로그">블로그 (통찰력)</option>
                                <option value="enhanced">향상됨 (AI 분석)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="content_length" class="form-label-custom">길이</label>
                            <select class="form-control-custom" name="content_length" id="content_length">
                                <option value="1000">1000자 (짧음)</option>
                                <option value="2000" selected>2000자 (중간)</option>
                                <option value="3000">3000자 (김)</option>
                                <option value="4000">4000자 (전문적)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Policy Auto -->
                    <div class="mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="policy_auto" name="policy_auto"
                                value="1">
                            <label class="form-check-label" for="policy_auto">균형 잡힌 관점 자동 적용</label>
                        </div>
                    </div>

                    <!-- Inputs -->
                    <div class="mb-4">
                        <label for="url_input" class="form-label-custom">출처 URL (선택사항)</label>
                        <input type="url" id="url_input" class="form-control-custom"
                            placeholder="https://example.com/article">
                    </div>

                    <div class="mb-4">
                        <label for="text_input" class="form-label-custom">주제 / 문맥</label>
                        <textarea id="text_input" class="form-control-custom" rows="6"
                            placeholder="주제나 문맥을 입력하세요..."></textarea>
                    </div>

                    <!-- Actions -->
                    <div class="d-flex gap-3">
                        <button id="generate-btn" class="btn-custom" onclick="generateContent()">
                            <span id="btn-spinner" class="spinner-border spinner-border-sm d-none me-2" role="status"
                                aria-hidden="true"></span>
                            <span id="btn-text">콘텐츠 생성</span>
                        </button>
                        <button id="cancel-btn" class="btn btn-outline-danger" type="button"
                            onclick="cancelGeneration()" style="display: none;">
                            중지
                        </button>
                    </div>
                </div>

                <!-- Progress -->
                <div class="card-custom mb-4" id="progress-container" style="display: none;">
                    <h5 class="section-title mb-3">생성 중...</h5>
                    <p class="text-muted mb-2" id="progress-message">초기화 중...</p>
                    <div class="progress mb-3" style="height: 6px;">
                        <div class="progress-bar bg-dark" id="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex gap-4 text-sm text-muted">
                        <span>AI 상태: <span id="ai-status" class="fw-medium">대기 중</span></span>
                        <span>SEO 상태: <span id="seo-status" class="fw-medium">대기 중</span></span>
                    </div>
                </div>

                <!-- Results -->
                <div class="card-custom" id="result-wrapper">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="section-title mb-0">결과</h2>
                        <div class="d-flex gap-2">
                            <span class="badge-custom" id="content-status">준비됨</span>
                            <button id="copy-btn" class="btn-outline-custom py-1 px-3 d-none"
                                onclick="copyResult()">복사</button>
                            <button id="download-btn" class="btn-outline-custom py-1 px-3 d-none"
                                onclick="downloadResult()">다운로드</button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded border">
                                <small class="text-muted d-block mb-1">키워드</small>
                                <div id="keywords-container" class="fw-medium">-</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex gap-3">
                                <div class="flex-fill p-3 bg-light rounded border text-center">
                                    <small class="text-muted d-block mb-1">개수</small>
                                    <div id="keyword-count-container" class="fw-bold">-</div>
                                </div>
                                <div class="flex-fill p-3 bg-light rounded border text-center">
                                    <small class="text-muted d-block mb-1">길이</small>
                                    <div id="content-length-container" class="fw-bold">-</div>
                                </div>
                                <div class="flex-fill p-3 bg-light rounded border text-center">
                                    <small class="text-muted d-block mb-1">단어 수</small>
                                    <div id="word-count-container" class="fw-bold">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Metrics -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-12">
                            <div class="p-3 bg-light rounded border">
                                <h6 class="fw-bold mb-3">상세 분석 지표</h6>
                                <div class="row text-center">
                                    <div class="col-md-3 mb-2">
                                        <small class="text-muted d-block">명사</small>
                                        <span id="noun-count" class="fw-bold">-</span>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <small class="text-muted d-block">동사</small>
                                        <span id="verb-count" class="fw-bold">-</span>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <small class="text-muted d-block">형용사</small>
                                        <span id="adj-count" class="fw-bold">-</span>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <small class="text-muted d-block">최대 문장 길이</small>
                                        <span id="max-sent-len" class="fw-bold">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Evaluation Score -->
                    <div class="mb-4">
                        <div class="p-3 bg-light rounded border">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0 fw-bold">AI 가이드라인 준수 평가</h6>
                                <span class="badge bg-primary fs-6" id="eval-score">점수: -</span>
                            </div>
                            <p class="text-muted small mb-0" id="eval-reason">평가 대기 중...</p>
                        </div>
                    </div>


                    <!-- Guidelines Summary -->
                    <div id="guidelines-summary" style="display: none;" class="mb-4">
                        <div class="p-3 bg-light rounded border">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0 fw-bold">가이드라인 준수</h6>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge bg-success" id="guidelines-compliance-score">점수: -</span>
                                    <button class="btn btn-sm btn-link text-dark text-decoration-none"
                                        onclick="toggleGuidelinesDetails()">상세</button>
                                    <button class="btn btn-sm btn-link text-dark text-decoration-none"
                                        onclick="showComplianceGuide()">도움말</button>
                                </div>
                            </div>

                            <div id="guidelines-details" class="collapse">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <small class="text-muted d-block mb-2">설정됨</small>
                                        <div id="configured-guidelines">-</div>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted d-block mb-2">적용됨</small>
                                        <div id="applied-results">-</div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="progress" style="height: 6px;">
                                        <div id="compliance-progress" class="progress-bar bg-success" style="width: 0%">
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mt-1 text-muted small">
                                        <span>0%</span>
                                        <span id="compliance-percentage">0%</span>
                                        <span>100%</span>
                                    </div>
                                </div>
                                <div id="improvement-suggestions" class="mt-3" style="display: none;"></div>
                            </div>

                            <!-- Hidden container for applied guidelines text -->
                            <div id="applied-guidelines-container" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- AI Analysis Stats (Hidden by default, used by scripts) -->
                    <div id="ai-analysis-stats" style="display: none !important;"></div>

                    <!-- Content Area -->
                    <div id="result-container" class="p-4 bg-white border rounded" style="min-height: 300px;">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-file-text fs-1 mb-3 d-block"></i>
                            <p>생성된 콘텐츠가 여기에 표시됩니다.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="complianceGuideModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">준수 가이드</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="compliance-guide-content"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="applySuggestionsBtn"
                        onclick="applyComplianceSuggestions()">제안 적용</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="analysisHelpModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="analysisHelpModalLabel">분석 도움말</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="analysis-help-content"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentAbortController = null;

        // HTML 코드 블록 제거 함수 (전역)
        function removeCodeBlocks(content) {
            if (!content || typeof content !== 'string') {
                return content;
            }

            return content
                .replace(/```html\s*[\s\S]*?\s*```/gi, '') // ```html 블록 제거
                .replace(/'''html\s*[\s\S]*?\s*'''/gi, '') // '''html 블록 제거
                .replace(/```\s*[\s\S]*?\s*```/gi, '') // 기타 ``` 블록 제거
                .replace(/'''\s*[\s\S]*?\s*'''/gi, '') // 기타 ''' 블록 제거
                .replace(/`[^`]*`/gi, '') // 단일 ` 블록 제거
                .trim(); // 앞뒤 공백 제거
        }

        // HTML 블록에서 실제 HTML 콘텐츠만 추출하는 함수
        function extractHtmlContent(content) {
            if (!content || typeof content !== 'string') {
                return content;
            }

            // ```html 블록에서 HTML 콘텐츠 추출
            const htmlBlockMatch = content.match(/```html\s*([\s\S]*?)\s*```/i);
            if (htmlBlockMatch) {
                return htmlBlockMatch[1].trim();
            }

            // '''html 블록에서 HTML 콘텐츠 추출
            const htmlBlockMatch2 = content.match(/'''html\s*([\s\S]*?)\s*'''/i);
            if (htmlBlockMatch2) {
                return htmlBlockMatch2[1].trim();
            }

            // HTML 블록이 없으면 코드 블록만 제거
            return removeCodeBlocks(content);
        }

        // 모달 접근성 개선을 위한 전역 설정
        document.addEventListener('DOMContentLoaded', function () {
            // 모든 모달에 대한 접근성 개선
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                // aria-hidden 속성 제거 (Bootstrap이 자동으로 관리)
                modal.removeAttribute('aria-hidden');

                // 모달 이벤트 리스너 추가
                modal.addEventListener('show.bs.modal', function () {
                    // 모달이 열리기 전에 포커스 트랩 설정
                    const focusableElements = modal.querySelectorAll(
                        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                    );
                    if (focusableElements.length > 0) {
                        focusableElements[0].focus();
                    }
                });

                modal.addEventListener('shown.bs.modal', function () {
                    // 모달이 완전히 열린 후 포커스 관리
                    const firstFocusable = modal.querySelector(
                        'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
                    );
                    if (firstFocusable) {
                        firstFocusable.focus();
                    }
                });

                modal.addEventListener('hidden.bs.modal', function () {
                    // 모달이 닫힌 후 포커스 복원
                    const generateBtn = document.getElementById('generate-btn');
                    if (generateBtn) {
                        generateBtn.focus();
                    }
                });
            });

            // 전역 오류 핸들러 추가
            window.addEventListener('error', function (event) {
                console.error('전역 오류 발생:', event.error);
                // 사용자에게 오류 알림 (필요한 경우)
                if (event.error && event.error.message && !event.error.message.includes('Script error')) {
                    showAlert('danger', '예상치 못한 오류가 발생했습니다. 페이지를 새로고침해주세요.');
                }
            });

            // Promise 오류 핸들러 추가
            window.addEventListener('unhandledrejection', function (event) {
                console.error('처리되지 않은 Promise 오류:', event.reason);
                event.preventDefault(); // 기본 오류 처리 방지

                // 메시지 채널 오류는 무시 (브라우저 확장 프로그램 관련)
                if (event.reason && event.reason.message &&
                    event.reason.message.includes('message channel closed')) {
                    return;
                }

                // 다른 Promise 오류는 사용자에게 알림
                showAlert('warning', '작업 중 일시적인 오류가 발생했습니다. 다시 시도해주세요.');
            });
        });

        async function generateContent() {
            const text = document.getElementById('text_input').value.trim();
            const resultDiv = document.getElementById('result-container');
            const keywordsDiv = document.getElementById('keywords-container');
            const keywordCountDiv = document.getElementById('keyword-count-container');
            const wordCountDiv = document.getElementById('word-count-container');
            const contentLengthDiv = document.getElementById('content-length-container');
            const generateBtn = document.getElementById('generate-btn');
            const btnSpinner = document.getElementById('btn-spinner');
            const copyBtn = document.getElementById('copy-btn');
            const downloadBtn = document.getElementById('download-btn');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressMessage = document.getElementById('progress-message');
            const aiStatus = document.getElementById('ai-status');
            const seoStatus = document.getElementById('seo-status');
            const cancelBtn = document.getElementById('cancel-btn');

            // URL 입력 확인
            const urlInput = document.getElementById('url_input');
            const url = urlInput ? urlInput.value.trim() : '';

            // URL이나 텍스트 중 하나는 반드시 입력되어야 함
            if (!text && !url) {
                alert('URL 또는 텍스트를 입력해주세요.');
                return;
            }

            // UI 상태 초기화 (null 체크 포함)
            if (generateBtn) {
                generateBtn.disabled = true;
            }
            if (btnSpinner) {
                btnSpinner.classList.remove('d-none');
            }
            if (copyBtn) {
                copyBtn.classList.add('d-none');
            }
            if (downloadBtn) {
                downloadBtn.classList.add('d-none');
            }
            if (progressContainer) {
                progressContainer.style.display = 'block';
            }
            if (cancelBtn) {
                cancelBtn.style.display = 'inline-block';
            }

            // 결과 컨테이너 초기화
            resultDiv.innerHTML = `
                <div class="text-center text-muted py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mb-0">AI가 콘텐츠를 생성하고 있습니다...</p>
                </div>
            `;

            // 콘텐츠 상태 업데이트
            const contentStatus = document.getElementById('content-status');
            contentStatus.textContent = '생성 중';
            contentStatus.className = 'badge bg-warning me-2';

            // 진행률 초기화 (null 체크 포함)
            if (progressBar) {
                progressBar.style.width = '0%';
            }
            if (progressMessage) {
                progressMessage.textContent = '초기화 중...';
            }
            if (aiStatus) {
                aiStatus.textContent = '대기 중';
            }
            if (seoStatus) {
                seoStatus.textContent = '대기 중';
            }

            // AbortController 설정
            currentAbortController = new AbortController();

            try {
                // 선택된 옵션들 가져오기
                const ruleCheckboxes = document.querySelectorAll('input[name="rules"]:checked');
                const rules = Array.from(ruleCheckboxes).map(cb => cb.value);
                const aiMode = document.getElementById('ai_mode').value;
                const contentLength = document.getElementById('content_length').value;
                const policyAuto = document.getElementById('policy_auto').checked;

                // 견고한 파이프라인 사용 여부 결정
                const useRobustPipeline = url || text.length > 500; // URL이 있거나 긴 텍스트인 경우

                // 입력 텍스트 보완 (텍스트가 없는 경우 빈 문자열 사용)
                const inputText = text || "";
                const enhancement = enhanceInputText(inputText, rules, aiMode);
                const enhancedText = enhancement.enhancedText;
                const enhancementNotes = enhancement.enhancementNotes;

                // 추가 보완 사항 제안
                const improvementSuggestions = generateImprovementSuggestions(rules, aiMode, contentLength);

                // 설정된 가이드라인 정보 저장 (전역 변수로)
                window.currentGuidelinesConfig = {
                    rules: rules,
                    aiMode: aiMode,
                    contentLength: contentLength,
                    policyAuto: policyAuto,
                    enhancementNotes: enhancementNotes,
                    improvementSuggestions: improvementSuggestions
                };

                // 적용된 가이드라인 표시
                displayAppliedGuidelines(rules, aiMode, contentLength, policyAuto, enhancementNotes, improvementSuggestions);

                // 요청 데이터 구성
                const requestData = {
                    text: enhancedText,
                    url: url,
                    rules: rules,
                    ai_mode: aiMode,
                    content_length: contentLength,
                    policy_auto: policyAuto
                };

                // 진행률 업데이트 (null 체크 포함)
                if (progressBar) {
                    progressBar.style.width = '25%';
                }
                if (progressMessage) {
                    progressMessage.textContent = 'AI 모델 초기화 중...';
                }
                if (aiStatus) {
                    aiStatus.textContent = '처리 중';
                }

                // API 엔드포인트 선택 - 견고한 파이프라인 우선 사용
                let apiEndpoint;
                if (useRobustPipeline) {
                    apiEndpoint = '/api/v1/generate-post-pipeline-robust';
                    if (progressMessage) {
                        progressMessage.textContent = '견고한 파이프라인으로 처리 중...';
                    }
                } else {
                    apiEndpoint = '/api/v1/generate-post-gemini-2-flash';
                    if (aiMode === 'enhanced') {
                        apiEndpoint = '/api/v1/generate-post-enhanced';
                    }
                }

                // API 호출
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                    signal: currentAbortController.signal
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // 진행률 업데이트 (null 체크 포함)
                if (progressBar) {
                    progressBar.style.width = '75%';
                }
                if (progressMessage) {
                    progressMessage.textContent = 'SEO 분석 중...';
                }
                if (seoStatus) {
                    seoStatus.textContent = '처리 중';
                }

                const result = await response.json();

                if (result.success) {
                    // 진행률 완료 (null 체크 포함)
                    if (progressBar) {
                        progressBar.style.width = '100%';
                    }
                    if (progressMessage) {
                        progressMessage.textContent = '완료!';
                    }
                    if (aiStatus) {
                        aiStatus.textContent = '완료';
                    }
                    if (seoStatus) {
                        seoStatus.textContent = '완료';
                    }

                    // 결과 표시 - 새로운 템플릿 사용
                    const data = result.data;

                    // 콘텐츠 검증
                    if (!data.content || data.content.trim().length === 0) {
                        throw new Error('생성된 콘텐츠가 비어있습니다. 다시 시도해주세요.');
                    }

                    console.log('API 응답 데이터:', data);
                    console.log('콘텐츠 길이:', data.content.length);
                    console.log('콘텐츠 시작 부분:', data.content.substring(0, 100));
                    console.log('콘텐츠 끝 부분:', data.content.substring(data.content.length - 100));

                    const aiMode = document.getElementById('ai_mode').value;
                    resultDiv.innerHTML = generateContentTemplate(data, aiMode);

                    // 콘텐츠 상태 업데이트
                    const contentStatus = document.getElementById('content-status');
                    contentStatus.textContent = '완료';
                    contentStatus.className = 'badge bg-success me-2';

                    // 정확한 콘텐츠 길이 측정 (본문만, 요약 제외)
                    console.log('=== generateContent에서 HTML 정제 과정 ===');

                    // HTML 블록에서 실제 HTML 콘텐츠만 추출
                    let generateCleanContent = extractHtmlContent(data.content);
                    console.log('HTML 블록 추출 성공, 길이:', generateCleanContent.length);

                    // 2단계: generateCleanContent가 비어있으면 원본 사용
                    if (!generateCleanContent || generateCleanContent.trim().length === 0) {
                        console.log('generateCleanContent가 비어있어서 원본 data.content 사용');
                        generateCleanContent = data.content;
                        console.log('원본 사용 후 길이:', generateCleanContent.length);
                    }

                    // 3단계: HTML 태그 단계별 제거
                    let contentText = generateCleanContent;

                    // H1-H4 태그만 제거
                    contentText = contentText.replace(/<h[1-4][^>]*>.*?<\/h[1-4]>/gi, '');
                    console.log('H1-H4 제거 후 길이:', contentText.length);

                    // 나머지 HTML 태그 제거
                    contentText = contentText.replace(/<[^>]*>/g, '');
                    console.log('모든 HTML 태그 제거 후 길이:', contentText.length);

                    // 공백 정리
                    contentText = contentText.replace(/\s+/g, ' ').trim();
                    console.log('공백 정리 후 길이:', contentText.length);

                    // 4단계: contentText가 비어있으면 H1-H4만 제거한 버전 사용
                    if (!contentText || contentText.trim().length === 0) {
                        console.log('contentText가 비어있어서 H1-H4만 제거한 버전 사용');
                        contentText = generateCleanContent
                            .replace(/<h[1-4][^>]*>.*?<\/h[1-4]>/gi, '')
                            .replace(/\s+/g, ' ')
                            .trim();
                        console.log('H1-H4만 제거 후 길이:', contentText.length);
                    }

                    // 요약/본문 분리하여 본문만 카운트
                    console.log('=== generateContent에서 요약/본문 분리 시작 ===');
                    const { summary, body } = extractSummaryAndBody(contentText);
                    const actualContentLength = body.length;
                    const actualWordCount = body.split(' ').filter(word => word.length > 0).length;

                    console.log('generateContent 카운트 결과:');
                    console.log('- 본문 길이:', actualContentLength);
                    console.log('- 본문 단어수:', actualWordCount);

                    // 통계 업데이트 (본문 기준)
                    keywordsDiv.textContent = data.keywords || '키워드 없음';
                    keywordCountDiv.textContent = data.keywords ? data.keywords.split(',').length : 0;
                    contentLengthDiv.textContent = actualContentLength.toLocaleString();
                    wordCountDiv.textContent = actualWordCount.toLocaleString();

                    // 상세 지표 업데이트
                    if (data.metrics) {
                        document.getElementById('noun-count').textContent = data.metrics.noun_count || '-';
                        document.getElementById('verb-count').textContent = data.metrics.verb_count || '-';
                        document.getElementById('adj-count').textContent = data.metrics.adjective_count || '-';
                        document.getElementById('max-sent-len').textContent = data.metrics.max_sentence_length || '-';
                    }

                    // 평가 점수 업데이트
                    if (data.score !== undefined) {
                        document.getElementById('eval-score').textContent = `점수: ${data.score}`;
                        document.getElementById('eval-reason').textContent = data.evaluation || '평가 내용 없음';
                    }


                    // 가이드라인 분석 및 표시
                    // 현재 생성된 콘텐츠 저장
                    currentGeneratedContent = data.content;

                    // 가이드라인 분석 - 백엔드 데이터 우선, 없으면 프론트엔드 분석
                    if (data.guidelines_analysis) {
                        console.log('백엔드 가이드라인 분석 사용:', data.guidelines_analysis);
                        displayBackendGuidelinesAnalysis(data.guidelines_analysis);

                        // 준수도 점수 업데이트
                        const complianceScore = document.getElementById('guidelines-compliance-score');
                        const complianceProgress = document.getElementById('compliance-progress');
                        const compliancePercentage = document.getElementById('compliance-percentage');

                        if (complianceScore && complianceProgress && compliancePercentage) {
                            const score = calculateComplianceScore(data.guidelines_analysis);
                            complianceScore.textContent = `준수도: ${score}%`;
                            complianceProgress.style.width = `${score}%`;
                            compliancePercentage.textContent = `${score}%`;
                        }
                    } else {
                        console.log('프론트엔드 가이드라인 분석 사용');
                        console.log('분석할 콘텐츠 길이:', data.content ? data.content.length : 'undefined');
                        const contentAnalysis = analyzeContentGuidelines(data.content || '');
                        displayGuidelinesAnalysis(contentAnalysis);

                        // 준수도 점수 업데이트
                        const complianceScore = document.getElementById('guidelines-compliance-score');
                        const complianceProgress = document.getElementById('compliance-progress');
                        const compliancePercentage = document.getElementById('compliance-percentage');

                        if (complianceScore && complianceProgress && compliancePercentage) {
                            const score = calculateComplianceRate(contentAnalysis);
                            complianceScore.textContent = `준수도: ${score}%`;
                            complianceProgress.style.width = `${score}%`;
                            compliancePercentage.textContent = `${score}%`;
                        }
                    }

                    // 설정과 결과 간의 연결성 표시
                    if (window.currentGuidelinesConfig) {
                        displayGuidelinesCompliance(data.content, window.currentGuidelinesConfig);
                    }

                    // AI 분석 결과 업데이트 (새로운 템플릿 내에서 처리)
                    setTimeout(() => {
                        const trustScoreContainer = document.getElementById('trust-score-container');
                        const trustReasonContainer = document.getElementById('trust-reason-container');
                        const seoScoreContainer = document.getElementById('seo-score-container');
                        const seoReasonContainer = document.getElementById('seo-reason-container');
                        const aiSummaryContainer = document.getElementById('ai-summary-container');

                        if (data.ai_analysis) {
                            // 백엔드 AI 분석 데이터 사용
                            trustScoreContainer.textContent = `${data.ai_analysis.trust_score}/5`;
                            trustReasonContainer.textContent = data.ai_analysis.trust_reason || '-';
                            seoScoreContainer.textContent = `${data.ai_analysis.seo_score}/10`;
                            seoReasonContainer.textContent = data.ai_analysis.seo_reason || '-';
                            aiSummaryContainer.textContent = data.ai_analysis.ai_summary || '-';
                        } else {
                            // 기본 분석 수행 - 안전한 HTML 정제
                            let analysisCleanContent = extractHtmlContent(data.content);

                            // analysisCleanContent가 비어있으면 원본 사용
                            if (!analysisCleanContent || analysisCleanContent.trim().length === 0) {
                                analysisCleanContent = data.content;
                            }

                            let contentText = analysisCleanContent
                                .replace(/<h[1-4][^>]*>.*?<\/h[1-4]>/gi, '')
                                .replace(/<[^>]*>/g, '')
                                .replace(/\s+/g, ' ')
                                .trim();

                            // contentText가 비어있으면 H1-H4만 제거한 버전 사용
                            if (!contentText || contentText.trim().length === 0) {
                                contentText = analysisCleanContent
                                    .replace(/<h[1-4][^>]*>.*?<\/h[1-4]>/gi, '')
                                    .replace(/\s+/g, ' ')
                                    .trim();
                            }

                            const contentLength = contentText.length;
                            const hasKeywords = data.keywords && data.keywords.length > 0;
                            const hasStructure = data.content.includes('<h1') || data.content.includes('<h2');

                            const trustScore = contentLength > 1000 ? 4 : contentLength > 500 ? 3 : 2;
                            const seoScore = (hasKeywords ? 2 : 0) + (hasStructure ? 2 : 0) + (contentLength > 800 ? 2 : 1) + 3;
                            const summary = contentLength > 100 ?
                                `${contentText.substring(0, 100)}...` :
                                '생성된 콘텐츠에 대한 기본 요약';

                            trustScoreContainer.textContent = `${trustScore}/5`;
                            trustReasonContainer.textContent = contentLength > 1000 ? '상세한 콘텐츠로 높은 신뢰도' : '기본 신뢰도 평가';
                            seoScoreContainer.textContent = `${seoScore}/10`;
                            seoReasonContainer.textContent = hasKeywords && hasStructure ? '키워드와 구조 최적화됨' : '기본 SEO 최적화';
                            aiSummaryContainer.textContent = summary;
                        }
                    }, 100);

                    // 버튼 표시
                    copyBtn.classList.remove('d-none');
                    downloadBtn.classList.remove('d-none');

                    // 성공 메시지
                    showAlert('success', '콘텐츠가 성공적으로 생성되었습니다!');
                } else {
                    throw new Error(result.message || '콘텐츠 생성에 실패했습니다.');
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    showAlert('info', '콘텐츠 생성이 중단되었습니다.');
                } else {
                    console.error('Error:', error);

                    // 오류 메시지 개선
                    let errorMessage = error.message;
                    let errorType = 'danger';
                    let errorTitle = '콘텐츠 생성 중 오류가 발생했습니다.';

                    // 특정 오류 타입에 따른 메시지 개선
                    if (errorMessage.includes('API 키') || errorMessage.includes('OPENAI_API_KEY')) {
                        errorTitle = 'API 설정 문제';
                        errorMessage = 'API 키가 설정되지 않았습니다. 관리자에게 문의하세요.';
                        errorType = 'warning';
                    } else if (errorMessage.includes('번역') || errorMessage.includes('translation')) {
                        errorTitle = '번역 서비스 일시적 장애';
                        errorMessage = '번역 서비스에 일시적인 문제가 있습니다. 잠시 후 다시 시도해주세요.';
                        errorType = 'warning';
                    } else if (errorMessage.includes('길이') || errorMessage.includes('length')) {
                        errorTitle = '콘텐츠 길이 부족';
                        errorMessage = '생성된 콘텐츠가 너무 짧습니다. 더 긴 텍스트를 입력하거나 다시 시도해주세요.';
                        errorType = 'info';
                    } else if (errorMessage.includes('timeout') || errorMessage.includes('시간 초과')) {
                        errorTitle = '요청 시간 초과';
                        errorMessage = '요청이 시간 초과되었습니다. 네트워크 상태를 확인하고 다시 시도해주세요.';
                        errorType = 'warning';
                    }

                    resultDiv.innerHTML = `
                        <div class="text-center text-${errorType} py-5">
                            <i class="bi bi-exclamation-triangle fs-1 mb-3 d-block"></i>
                            <h5 class="mb-3">${errorTitle}</h5>
                            <p class="mb-3">${errorMessage}</p>
                            <div class="d-flex justify-content-center gap-2">
                                <button class="btn btn-outline-primary" onclick="generateContent()">
                                    <i class="bi bi-arrow-clockwise me-2"></i>다시 시도
                                </button>
                                <button class="btn btn-outline-secondary" onclick="showHelpModal()">
                                    <i class="bi bi-question-circle me-2"></i>도움말
                                </button>
                            </div>
                        </div>
                    `;

                    // 콘텐츠 상태 업데이트
                    const contentStatus = document.getElementById('content-status');
                    contentStatus.textContent = '오류';
                    contentStatus.className = `badge bg-${errorType} me-2`;

                    showAlert(errorType, errorMessage);
                }

                // 통계 초기화
                keywordsDiv.textContent = '-';
                keywordCountDiv.textContent = '-';
                contentLengthDiv.textContent = '-';
                wordCountDiv.textContent = '-';
            } finally {
                // UI 상태 복원 (null 체크 포함)
                if (generateBtn) {
                    generateBtn.disabled = false;
                }
                if (btnSpinner) {
                    btnSpinner.classList.add('d-none');
                }
                if (progressContainer) {
                    progressContainer.style.display = 'none';
                }
                if (cancelBtn) {
                    cancelBtn.style.display = 'none';
                }
                currentAbortController = null;
            }
        }

        function cancelGeneration() {
            if (currentAbortController) {
                currentAbortController.abort();
            }
        }

        function copyResult() {
            const resultDiv = document.getElementById('result-container');
            const content = resultDiv.innerText || resultDiv.textContent;

            navigator.clipboard.writeText(content).then(() => {
                showAlert('success', '결과가 클립보드에 복사되었습니다!');
            }).catch(() => {
                showAlert('danger', '복사에 실패했습니다.');
            });
        }

        function displayAppliedGuidelines(rules, aiMode, contentLength, policyAuto, enhancementNotes = [], improvementSuggestions = []) {
            const guidelinesSummary = document.getElementById('guidelines-summary');
            const appliedGuidelinesContainer = document.getElementById('applied-guidelines-container');
            const configuredGuidelines = document.getElementById('configured-guidelines');
            const complianceScore = document.getElementById('guidelines-compliance-score');
            const complianceProgress = document.getElementById('compliance-progress');
            const compliancePercentage = document.getElementById('compliance-percentage');
            const guidelinesDetails = document.getElementById('guidelines-details');
            const appliedResults = document.getElementById('applied-results');

            let guidelines = [];
            let guidelineCount = 0;
            let totalGuidelines = 0;

            // 선택된 규칙들
            if (rules.length > 0) {
                totalGuidelines += rules.length;
                rules.forEach(rule => {
                    switch (rule) {
                        case 'AI_SEO':
                            guidelines.push('🤖 AI SEO: 키워드 최적화, 구조화된 데이터');
                            break;
                        case 'AI_SEARCH':
                            guidelines.push('🔍 AI SEARCH: 검색 의도 반영, Featured Snippet');
                            break;
                        case 'AEO':
                            guidelines.push('💬 AEO: 질문 답변, FAQ 형식');
                            break;
                        case 'GEO':
                            guidelines.push('🌐 GEO: AI 인용, 신뢰성 강화');
                            break;
                        case 'AIO':
                            guidelines.push('🔧 AIO: AI 도구 통합, API 친화적');
                            break;
                    }
                });
            }

            // AI 모드
            if (aiMode) {
                totalGuidelines += 1;
                switch (aiMode) {
                    case '뉴스':
                        guidelines.push('📰 뉴스 스타일: 객관적, 최신 정보');
                        break;
                    case '리뷰':
                        guidelines.push('⭐ 리뷰 스타일: 장단점, 경험 공유');
                        break;
                    case '가이드':
                        guidelines.push('📋 가이드 스타일: 단계별 설명');
                        break;
                    case '요약':
                        guidelines.push('📝 요약 스타일: 핵심만 간결하게');
                        break;
                    case '블로그':
                        guidelines.push('✍️ 블로그 스타일: 개인적 인사이트');
                        break;
                    case 'enhanced':
                        guidelines.push('🌟 향상된 모드: AI 분석 포함');
                        break;
                    case 'enhanced_gemini':
                        guidelines.push('🚀 향상된 Gemini: 고성능 AI 분석');
                        break;
                }
            }

            // 콘텐츠 길이
            if (contentLength) {
                totalGuidelines += 1;
                guidelines.push(`📏 콘텐츠 길이: ${contentLength}자`);
            }

            // 정책 자동 적용
            if (policyAuto) {
                totalGuidelines += 1;
                guidelines.push('⚖️ 균형 잡힌 관점 자동 적용');
            }

            if (guidelines.length > 0) {
                appliedGuidelinesContainer.innerHTML = guidelines.map(g => `<span class="badge bg-light text-dark me-1 mb-1">${g}</span>`).join('');

                // 설정된 가이드라인 표시
                let configuredContent = guidelines.map(g => `<div class="mb-1">• ${g}</div>`).join('');

                // 보완 사항 표시
                if (enhancementNotes.length > 0) {
                    configuredContent += '<div class="mt-3"><h6 class="text-success mb-2"><i class="bi bi-plus-circle me-1"></i>적용된 보완 사항</h6>';
                    configuredContent += enhancementNotes.map(note => `<div class="mb-1 text-success">✓ ${note}</div>`).join('');
                    configuredContent += '</div>';
                }

                configuredGuidelines.innerHTML = configuredContent;

                // 추가 보완 제안 표시
                if (improvementSuggestions.length > 0) {
                    const suggestionsContainer = document.getElementById('improvement-suggestions');
                    if (suggestionsContainer) {
                        let suggestionsContent = '<div class="mt-3"><h6 class="text-warning mb-2"><i class="bi bi-lightbulb me-1"></i>추가 보완 제안</h6>';
                        improvementSuggestions.forEach(suggestion => {
                            const priorityClass = suggestion.priority === 'high' ? 'text-danger' :
                                suggestion.priority === 'medium' ? 'text-warning' : 'text-info';
                            const priorityIcon = suggestion.priority === 'high' ? 'bi-exclamation-triangle' :
                                suggestion.priority === 'medium' ? 'bi-exclamation-circle' : 'bi-info-circle';
                            suggestionsContent += `
                                <div class="suggestion-item mb-2 p-2 rounded" style="background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b;">
                                    <div class="d-flex align-items-start">
                                        <i class="bi ${priorityIcon} ${priorityClass} me-2 mt-1"></i>
                                        <div>
                                            <div class="fw-medium">${suggestion.title}</div>
                                            <small class="text-muted">${suggestion.description}</small>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        suggestionsContent += '</div>';
                        suggestionsContainer.innerHTML = suggestionsContent;
                        suggestionsContainer.style.display = 'block';
                    }
                }

                // 준수도 계산 (기본값으로 설정, 실제 분석은 별도 함수에서 처리)
                const complianceRate = 0; // 초기값, 실제 콘텐츠 분석 후 업데이트됨
                complianceScore.textContent = `준수도: ${complianceRate}%`;
                complianceProgress.style.width = `${complianceRate}%`;
                compliancePercentage.textContent = `${complianceRate}%`;

                guidelinesSummary.style.display = 'block';
            } else {
                guidelinesSummary.style.display = 'none';
            }
        }

        function analyzeContentGuidelines(content) {
            console.log('=== analyzeContentGuidelines 시작 ===');
            console.log('입력 콘텐츠 타입:', typeof content);
            console.log('입력 콘텐츠 길이:', content ? content.length : 'undefined');
            console.log('입력 콘텐츠 시작:', content ? content.substring(0, 100) : 'undefined');

            const analysis = {
                hasStructuredData: false,
                hasFAQ: false,
                hasKeywords: false,
                hasHeadings: false,
                hasLinks: false,
                hasImages: false,
                hasPolicyBalance: false,
                contentLength: 0,
                aiSeoCompliance: false,
                geoCompliance: false,
                policyBalanceCompliance: false
            };

            // 콘텐츠 유효성 검사
            if (!content || typeof content !== 'string' || content.trim().length === 0) {
                console.error('유효하지 않은 콘텐츠:', content);
                analysis.contentLength = 0;
                return analysis;
            }

            // HTML 블록에서 실제 콘텐츠 추출
            let processedContent = content;
            const htmlBlockMatch = content.match(/```html\s*([\s\S]*?)\s*```/i);
            if (htmlBlockMatch) {
                processedContent = htmlBlockMatch[1];
                console.log('HTML 블록에서 콘텐츠 추출됨, 길이:', processedContent.length);
            }

            // 콘텐츠 길이 확인 (HTML 태그 제거 후)
            const analysisCleanContent = processedContent.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
            analysis.contentLength = analysisCleanContent.length;
            console.log('정제된 콘텐츠 길이:', analysis.contentLength);

            // 구조화된 데이터 확인
            if (content.includes('itemscope') || content.includes('schema.org') || content.includes('ld+json')) {
                analysis.hasStructuredData = true;
            }

            // FAQ 확인 (더 정확한 패턴)
            if (content.includes('FAQ') || content.includes('자주 묻는 질문') || content.includes('Q&A') ||
                content.includes('질문') || content.includes('답변') || content.includes('faq')) {
                analysis.hasFAQ = true;
            }

            // 키워드 확인 (H1, H2, H3 태그에서)
            if (content.includes('<h1') || content.includes('<h2') || content.includes('<h3')) {
                analysis.hasKeywords = true;
            }

            // 헤딩 구조 확인 (계층적 구조)
            if (content.includes('<h1') && content.includes('<h2')) {
                analysis.hasHeadings = true;
            }

            // 링크 확인
            if (content.includes('<a href') || content.includes('http') || content.includes('https')) {
                analysis.hasLinks = true;
            }

            // 이미지 확인
            if (content.includes('<img') || content.includes('alt=') || content.includes('src=')) {
                analysis.hasImages = true;
            }

            // 정책 균형 확인 (더 포괄적인 키워드)
            const balanceKeywords = ['장단점', '고려사항', '주의사항', '장점', '단점', '이점', '한계',
                '주의', '경고', '리스크', '위험', '장애', '문제', '해결책', '대안'];
            if (balanceKeywords.some(keyword => content.includes(keyword))) {
                analysis.hasPolicyBalance = true;
                analysis.policyBalanceCompliance = true;
            }

            // AI SEO 준수도 확인 (길이 + 구조)
            if (analysis.contentLength >= 1500 && analysis.hasHeadings && analysis.hasKeywords) {
                analysis.aiSeoCompliance = true;
            }

            // GEO 준수도 확인 (생성형 AI 엔진 최적화)
            const geoKeywords = [
                '생성형', 'ai', 'chatgpt', 'claude', 'gemini', 'ai 오버뷰', 'featured snippet',
                '구조화', 'schema', 'faq', 'how-to', '정의', '비교', '단계별', '가이드',
                '출처', '인용', '통계', '연구', '전문가', '권위', '신뢰성'
            ];
            const geoPatterns = ['<h1>', '<h2>', '<h3>', '<ul>', '<ol>', '<table>', '<details>', '<summary>'];
            const hasGeoKeywords = geoKeywords.some(keyword => content.toLowerCase().includes(keyword));
            const hasGeoStructure = geoPatterns.some(pattern => content.includes(pattern));
            const hasAuthoritativeLanguage = ['연구에 따르면', '전문가들은', '연구 결과', '통계에 따르면'].some(phrase => content.includes(phrase));

            if (hasGeoKeywords || hasGeoStructure || hasAuthoritativeLanguage) {
                analysis.geoCompliance = true;
            }

            console.log('분석 결과:', analysis);
            return analysis;
        }

        function displayGuidelinesAnalysis(analysis) {
            console.log('=== displayGuidelinesAnalysis 시작 ===');
            console.log('분석 데이터:', analysis);

            const guidelinesSummary = document.getElementById('guidelines-summary');
            const appliedGuidelinesContainer = document.getElementById('applied-guidelines-container');
            const appliedResults = document.getElementById('applied-results');
            const complianceProgress = document.getElementById('compliance-progress');
            const compliancePercentage = document.getElementById('compliance-percentage');
            const complianceScore = document.getElementById('guidelines-compliance-score');
            const guidelinesDetails = document.getElementById('guidelines-details');

            let analysisResults = [];
            let complianceCount = 0;
            let totalChecks = 0;

            // 콘텐츠 길이 확인 (가장 중요)
            totalChecks++;
            console.log('가이드라인 분석 - 콘텐츠 길이:', analysis.contentLength);
            if (analysis.contentLength >= 1500) {
                analysisResults.push(`<span class="badge bg-success me-1 mb-1">✅ 길이 준수 (${analysis.contentLength}자)</span>`);
                complianceCount++;
            } else if (analysis.contentLength > 0) {
                analysisResults.push(`<span class="badge bg-warning me-1 mb-1">⚠️ 길이 부분 준수 (${analysis.contentLength}자)</span>`);
            } else {
                analysisResults.push(`<span class="badge bg-danger me-1 mb-1">❌ 길이 미준수 (${analysis.contentLength}자)</span>`);
            }

            // AI SEO 준수도 확인
            totalChecks++;
            if (analysis.aiSeoCompliance) {
                analysisResults.push('<span class="badge bg-success me-1 mb-1">✅ AI SEO 준수</span>');
                complianceCount++;
            } else {
                analysisResults.push('<span class="badge bg-warning me-1 mb-1">⚠️ AI SEO 부분 준수</span>');
            }

            // GEO 준수도 확인
            totalChecks++;
            if (analysis.geoCompliance) {
                analysisResults.push('<span class="badge bg-success me-1 mb-1">✅ GEO 준수</span>');
                complianceCount++;
            } else {
                analysisResults.push('<span class="badge bg-warning me-1 mb-1">⚠️ GEO 부분 준수</span>');
            }

            // 정책 균형 확인
            totalChecks++;
            if (analysis.policyBalanceCompliance) {
                analysisResults.push('<span class="badge bg-success me-1 mb-1">✅ 정책 균형 준수</span>');
                complianceCount++;
            } else {
                analysisResults.push('<span class="badge bg-danger me-1 mb-1">❌ 정책 균형 미준수</span>');
            }

            // 블로그 스타일 확인
            totalChecks++;
            if (analysis.hasHeadings && analysis.hasKeywords) {
                analysisResults.push('<span class="badge bg-success me-1 mb-1">✅ 블로그 스타일 준수</span>');
                complianceCount++;
            } else {
                analysisResults.push('<span class="badge bg-warning me-1 mb-1">⚠️ 블로그 스타일 부분 준수</span>');
            }

            // 준수도 계산
            const complianceRate = totalChecks > 0 ? Math.round((complianceCount / totalChecks) * 100) : 0;

            if (analysisResults.length > 0) {
                // 중복 제거: appliedGuidelinesContainer는 제거하고 appliedResults만 사용
                appliedResults.innerHTML = analysisResults.map(result => {
                    // HTML 태그 제거하되 이모지 아이콘은 유지
                    const text = result.replace(/<[^>]*>/g, '');
                    // 아이콘과 텍스트 분리하여 중복 제거 (더 정확한 패턴)
                    const iconMatch = text.match(/^([^\s]+)\s*(.+)$/);
                    if (iconMatch) {
                        const icon = iconMatch[1];
                        const content = iconMatch[2];
                        return `<div class="result-item result-${getResultStatus(content)}">
                            <span class="result-icon">${icon}</span>
                            <span class="result-text">${content}</span>
                        </div>`;
                    }
                    return `<div class="result-item result-neutral">
                        <span class="result-icon">•</span>
                        <span class="result-text">${text}</span>
                    </div>`;
                }).join('');

                // 준수도 표시
                complianceScore.textContent = `준수도: ${complianceRate}%`;
                complianceProgress.style.width = `${complianceRate}%`;
                compliancePercentage.textContent = `${complianceRate}%`;

                // 준수도에 따른 색상 변경
                if (complianceRate >= 80) {
                    complianceScore.className = 'badge compliance-score bg-success me-2';
                    complianceProgress.className = 'progress-bar bg-success';
                } else if (complianceRate >= 60) {
                    complianceScore.className = 'badge compliance-score bg-warning me-2';
                    complianceProgress.className = 'progress-bar bg-warning';
                } else {
                    complianceScore.className = 'badge compliance-score bg-danger me-2';
                    complianceProgress.className = 'progress-bar bg-danger';
                }

                guidelinesDetails.classList.remove('show');
                guidelinesSummary.style.display = 'block';
            } else {
                appliedGuidelinesContainer.innerHTML = '-';
                appliedResults.innerHTML = '<div class="text-muted">분석 결과가 없습니다.</div>';
                guidelinesDetails.classList.add('show');
            }
        }

        function displayBackendGuidelinesAnalysis(analysis) {
            console.log('=== displayBackendGuidelinesAnalysis 시작 ===');
            console.log('백엔드 분석 데이터:', analysis);

            const guidelinesSummary = document.getElementById('guidelines-summary');
            const appliedGuidelinesContainer = document.getElementById('applied-guidelines-container');
            const appliedResults = document.getElementById('applied-results');
            const complianceProgress = document.getElementById('compliance-progress');
            const compliancePercentage = document.getElementById('compliance-percentage');
            const complianceScore = document.getElementById('guidelines-compliance-score');
            const guidelinesDetails = document.getElementById('guidelines-details');

            let analysisResults = [];
            let complianceCount = 0;
            let totalChecks = 0;

            // 콘텐츠 길이 확인 (백엔드 데이터 사용)
            totalChecks++;
            const contentLength = analysis.content_length || 0;
            console.log('백엔드 콘텐츠 길이:', contentLength);

            if (analysis.length_compliant) {
                analysisResults.push(`<span class="badge bg-success me-1 mb-1">✅ 길이 준수 (${contentLength}자)</span>`);
                complianceCount++;
            } else if (contentLength > 0) {
                analysisResults.push(`<span class="badge bg-warning me-1 mb-1">⚠️ 길이 부분 준수 (${contentLength}자)</span>`);
            } else {
                analysisResults.push(`<span class="badge bg-danger me-1 mb-1">❌ 길이 미준수 (${contentLength}자)</span>`);
            }

            // AI SEO 분석
            if (analysis.ai_seo_compliant) {
                totalChecks++;
                analysisResults.push('<span class="badge bg-success me-1 mb-1">✅ AI SEO 준수</span>');
                complianceCount++;
            } else {
                totalChecks++;
                analysisResults.push('<span class="badge bg-warning me-1 mb-1">⚠️ AI SEO 부분 준수</span>');
            }

            if (analysis.structured_data) {
                totalChecks++;
                analysisResults.push('<span class="badge bg-success me-1 mb-1">✅ 구조화된 데이터</span>');
                complianceCount++;
            } else {
                totalChecks++;
                analysisResults.push('<span class="badge bg-warning me-1 mb-1">⚠️ 구조화된 데이터 없음</span>');
            }
            if (analysis.keywords_optimized) {
                totalChecks++;
                analysisResults.push('<span class="badge bg-success me-1 mb-1">✅ 키워드 최적화</span>');
                complianceCount++;
            } else {
                totalChecks++;
                analysisResults.push('<span class="badge bg-warning me-1 mb-1">⚠️ 키워드 최적화 없음</span>');
            }
            if (analysis.headings_structure) {
                totalChecks++;
                analysisResults.push('<span class="badge bg-success me-1 mb-1">✅ 헤딩 구조</span>');
                complianceCount++;
            } else {
                totalChecks++;
                analysisResults.push('<span class="badge bg-warning me-1 mb-1">⚠️ 헤딩 구조 없음</span>');
            }
            if (analysis.links_included) {
                totalChecks++;
                analysisResults.push('<span class="badge bg-success me-1 mb-1">✅ 링크 포함</span>');
                complianceCount++;
            } else {
                totalChecks++;
                analysisResults.push('<span class="badge bg-warning me-1 mb-1">⚠️ 링크 없음</span>');
            }
            if (analysis.images_optimized) {
                totalChecks++;
                analysisResults.push('<span class="badge bg-success me-1 mb-1">✅ 이미지 최적화</span>');
                complianceCount++;
            } else {
                totalChecks++;
                analysisResults.push('<span class="badge bg-warning me-1 mb-1">⚠️ 이미지 최적화 없음</span>');
            }

            // AEO 분석
            if (analysis.aeo_applied) {
                totalChecks++;
                analysisResults.push('<span class="badge bg-info me-1 mb-1">💬 AEO 적용</span>');
                complianceCount++;
            }
            if (analysis.faq_included) {
                totalChecks++;
                analysisResults.push('<span class="badge bg-success me-1 mb-1">✅ FAQ 포함</span>');
                complianceCount++;
            } else {
                totalChecks++;
                analysisResults.push('<span class="badge bg-warning me-1 mb-1">⚠️ FAQ 없음</span>');
            }

            // GEO 분석
            if (analysis.geo_compliant) {
                totalChecks++;
                analysisResults.push('<span class="badge bg-success me-1 mb-1">✅ GEO 준수</span>');
                complianceCount++;
            } else {
                totalChecks++;
                analysisResults.push('<span class="badge bg-warning me-1 mb-1">⚠️ GEO 부분 준수</span>');
            }

            // 정책 균형 분석
            if (analysis.policy_balance_compliant) {
                totalChecks++;
                analysisResults.push('<span class="badge bg-success me-1 mb-1">✅ 정책 균형 준수</span>');
                complianceCount++;
            } else {
                totalChecks++;
                analysisResults.push('<span class="badge bg-danger me-1 mb-1">❌ 정책 균형 미준수</span>');
            }

            // AIO 분석
            if (analysis.aio_applied) {
                totalChecks++;
                analysisResults.push('<span class="badge bg-secondary me-1 mb-1">🔧 AIO 적용</span>');
                complianceCount++;
            }

            // 정책 분석
            if (analysis.policy_applied) {
                totalChecks++;
                analysisResults.push('<span class="badge bg-dark me-1 mb-1">⚖️ 정책 적용</span>');
                complianceCount++;
            }
            if (analysis.balance_perspective) {
                totalChecks++;
                analysisResults.push('<span class="badge bg-success me-1 mb-1">✅ 균형 잡힌 관점</span>');
                complianceCount++;
            } else {
                totalChecks++;
                analysisResults.push('<span class="badge bg-warning me-1 mb-1">⚠️ 균형 잡힌 관점 없음</span>');
            }

            // 준수도 계산
            const complianceRate = totalChecks > 0 ? Math.round((complianceCount / totalChecks) * 100) : 0;

            if (analysisResults.length > 0) {
                // 중복 제거: appliedGuidelinesContainer는 제거하고 appliedResults만 사용
                appliedResults.innerHTML = analysisResults.map(result => {
                    // HTML 태그 제거하되 이모지 아이콘은 유지
                    const text = result.replace(/<[^>]*>/g, '');
                    // 아이콘과 텍스트 분리하여 중복 제거 (더 정확한 패턴)
                    const iconMatch = text.match(/^([^\s]+)\s*(.+)$/);
                    if (iconMatch) {
                        const icon = iconMatch[1];
                        const content = iconMatch[2];
                        return `<div class="result-item result-${getResultStatus(content)}">
                            <span class="result-icon">${icon}</span>
                            <span class="result-text">${content}</span>
                        </div>`;
                    }
                    return `<div class="result-item result-neutral">
                        <span class="result-icon">•</span>
                        <span class="result-text">${text}</span>
                    </div>`;
                }).join('');

                // 준수도 표시
                complianceScore.textContent = `준수도: ${complianceRate}%`;
                complianceProgress.style.width = `${complianceRate}%`;
                compliancePercentage.textContent = `${complianceRate}%`;

                // 준수도에 따른 색상 변경
                if (complianceRate >= 80) {
                    complianceScore.className = 'badge compliance-score bg-success me-2';
                    complianceProgress.className = 'progress-bar bg-success';
                } else if (complianceRate >= 60) {
                    complianceScore.className = 'badge compliance-score bg-warning me-2';
                    complianceProgress.className = 'progress-bar bg-warning';
                } else {
                    complianceScore.className = 'badge compliance-score bg-danger me-2';
                    complianceProgress.className = 'progress-bar bg-danger';
                }

                guidelinesDetails.classList.remove('show');
                guidelinesSummary.style.display = 'block';
            } else {
                appliedGuidelinesContainer.innerHTML = '-';
                appliedResults.innerHTML = '<div class="text-muted">분석 결과가 없습니다.</div>';
                guidelinesDetails.classList.add('show');
            }
        }

        function downloadResult() {
            const resultDiv = document.getElementById('result-container');
            const content = resultDiv.innerText || resultDiv.textContent;
            const keywords = document.getElementById('keywords-container').textContent;

            const data = {
                title: 'AI SEO Blog Post',
                keywords: keywords,
                content: content,
                generated_at: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `blog-post-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showAlert('success', '결과가 다운로드되었습니다!');
        }

        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

            // 5초 후 자동 제거
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function toggleGuidelinesDetails() {
            const guidelinesDetails = document.getElementById('guidelines-details');
            guidelinesDetails.classList.toggle('show');
        }

        // AI 분석 도움말 표시 함수
        function showAnalysisHelp(type) {
            const modal = new bootstrap.Modal(document.getElementById('analysisHelpModal'));
            const modalTitle = document.getElementById('analysisHelpModalLabel');
            const modalBody = document.getElementById('analysis-help-content');

            if (type === 'trust') {
                modalTitle.innerHTML = '<i class="bi bi-shield-check text-success me-2"></i>신뢰도 평가 근거 자료';
                modalBody.innerHTML = generateTrustAnalysisHelp();
            } else if (type === 'seo') {
                modalTitle.innerHTML = '<i class="bi bi-search text-warning me-2"></i>SEO 최적화 점수 근거 자료';
                modalBody.innerHTML = generateSEOAnalysisHelp();
            }

            modal.show();
        }

        // 신뢰도 평가 도움말 생성
        function generateTrustAnalysisHelp() {
            const trustScore = document.getElementById('trust-score-container')?.textContent || '-';
            const trustReason = document.getElementById('trust-reason-container')?.textContent || '-';

            return `
                <div class="analysis-help-content">
                    <div class="current-score-section mb-4">
                        <h6 class="text-success mb-3">
                            <i class="bi bi-info-circle me-2"></i>현재 평가 결과
                        </h6>
                        <div class="score-display">
                            <div class="current-score">${trustScore}</div>
                            <div class="score-reason">${trustReason}</div>
                        </div>
                    </div>
                    
                    <div class="evaluation-criteria mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-list-check me-2"></i>신뢰도 평가 기준
                        </h6>
                        <div class="criteria-list">
                            <div class="criteria-item">
                                <div class="criteria-header">
                                    <span class="criteria-score">5점</span>
                                    <span class="criteria-title">매우 높은 신뢰도</span>
                                </div>
                                <div class="criteria-desc">
                                    전문가 인용, 공식 통계, 학술 자료, 최신 정보(1년 이내), 상세한 설명(1000자 이상)
                                </div>
                            </div>
                            <div class="criteria-item">
                                <div class="criteria-header">
                                    <span class="criteria-score">4점</span>
                                    <span class="criteria-title">높은 신뢰도</span>
                                </div>
                                <div class="criteria-desc">
                                    신뢰할 수 있는 출처, 객관적 사실, 상세한 설명(500자 이상), 최신 정보(3년 이내)
                                </div>
                            </div>
                            <div class="criteria-item">
                                <div class="criteria-header">
                                    <span class="criteria-score">3점</span>
                                    <span class="criteria-title">보통 신뢰도</span>
                                </div>
                                <div class="criteria-desc">
                                    기본적인 정보 제공, 일반적인 지식, 중간 길이 설명(200-500자)
                                </div>
                            </div>
                            <div class="criteria-item">
                                <div class="criteria-header">
                                    <span class="criteria-score">2점</span>
                                    <span class="criteria-title">낮은 신뢰도</span>
                                </div>
                                <div class="criteria-desc">
                                    간단한 설명, 출처 불명확, 주관적 의견, 짧은 내용(200자 미만)
                                </div>
                            </div>
                            <div class="criteria-item">
                                <div class="criteria-header">
                                    <span class="criteria-score">1점</span>
                                    <span class="criteria-title">매우 낮은 신뢰도</span>
                                </div>
                                <div class="criteria-desc">
                                    출처 없음, 주관적 의견, 부정확한 정보, 매우 짧은 내용
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="improvement-tips">
                        <h6 class="text-info mb-3">
                            <i class="bi bi-lightbulb me-2"></i>신뢰도 향상 팁
                        </h6>
                        <ul class="tips-list">
                            <li>신뢰할 수 있는 출처를 명시하세요</li>
                            <li>최신 통계나 데이터를 포함하세요</li>
                            <li>전문가 인용이나 학술 자료를 활용하세요</li>
                            <li>객관적이고 사실 중심의 내용을 작성하세요</li>
                            <li>상세하고 구체적인 설명을 제공하세요</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // SEO 최적화 점수 도움말 생성
        function generateSEOAnalysisHelp() {
            const seoScore = document.getElementById('seo-score-container')?.textContent || '-';
            const seoReason = document.getElementById('seo-reason-container')?.textContent || '-';

            return `
                <div class="analysis-help-content">
                    <div class="current-score-section mb-4">
                        <h6 class="text-warning mb-3">
                            <i class="bi bi-info-circle me-2"></i>현재 평가 결과
                        </h6>
                        <div class="score-display">
                            <div class="current-score">${seoScore}</div>
                            <div class="score-reason">${seoReason}</div>
                        </div>
                    </div>
                    
                    <div class="evaluation-criteria mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-list-check me-2"></i>SEO 최적화 평가 기준
                        </h6>
                        <div class="criteria-list">
                            <div class="criteria-item">
                                <div class="criteria-header">
                                    <span class="criteria-score">9-10점</span>
                                    <span class="criteria-title">매우 높은 최적화</span>
                                </div>
                                <div class="criteria-desc">
                                    키워드 최적화, 구조화된 데이터, 헤딩 구조, 링크 포함, 이미지 최적화, 메타 설명
                                </div>
                            </div>
                            <div class="criteria-item">
                                <div class="criteria-header">
                                    <span class="criteria-score">7-8점</span>
                                    <span class="criteria-title">높은 최적화</span>
                                </div>
                                <div class="criteria-desc">
                                    키워드 포함, 기본 헤딩 구조, 적절한 길이, 읽기 쉬운 구조
                                </div>
                            </div>
                            <div class="criteria-item">
                                <div class="criteria-header">
                                    <span class="criteria-score">5-6점</span>
                                    <span class="criteria-title">보통 최적화</span>
                                </div>
                                <div class="criteria-desc">
                                    기본적인 SEO 요소 포함, 중간 길이 콘텐츠, 기본 구조
                                </div>
                            </div>
                            <div class="criteria-item">
                                <div class="criteria-header">
                                    <span class="criteria-score">3-4점</span>
                                    <span class="criteria-title">낮은 최적화</span>
                                </div>
                                <div class="criteria-desc">
                                    SEO 요소 부족, 짧은 콘텐츠, 구조 부족
                                </div>
                            </div>
                            <div class="criteria-item">
                                <div class="criteria-header">
                                    <span class="criteria-score">1-2점</span>
                                    <span class="criteria-title">매우 낮은 최적화</span>
                                </div>
                                <div class="criteria-desc">
                                    SEO 요소 없음, 매우 짧은 콘텐츠, 구조 없음
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="seo-factors mb-4">
                        <h6 class="text-success mb-3">
                            <i class="bi bi-gear me-2"></i>SEO 평가 요소
                        </h6>
                        <div class="factors-grid">
                            <div class="factor-item">
                                <i class="bi bi-tags text-primary"></i>
                                <span>키워드 최적화 (2점)</span>
                            </div>
                            <div class="factor-item">
                                <i class="bi bi-diagram-3 text-success"></i>
                                <span>구조화된 데이터 (2점)</span>
                            </div>
                            <div class="factor-item">
                                <i class="bi bi-list-nested text-warning"></i>
                                <span>헤딩 구조 (2점)</span>
                            </div>
                            <div class="factor-item">
                                <i class="bi bi-link-45deg text-info"></i>
                                <span>링크 포함 (1점)</span>
                            </div>
                            <div class="factor-item">
                                <i class="bi bi-image text-danger"></i>
                                <span>이미지 최적화 (1점)</span>
                            </div>
                            <div class="factor-item">
                                <i class="bi bi-file-text text-secondary"></i>
                                <span>콘텐츠 길이 (2점)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="improvement-tips">
                        <h6 class="text-info mb-3">
                            <i class="bi bi-lightbulb me-2"></i>SEO 최적화 팁
                        </h6>
                        <ul class="tips-list">
                            <li>주요 키워드를 제목과 본문에 자연스럽게 포함하세요</li>
                            <li>H1, H2, H3 헤딩 태그를 사용하여 구조를 만드세요</li>
                            <li>관련 링크와 이미지를 포함하세요</li>
                            <li>충분한 길이의 콘텐츠를 작성하세요 (최소 500자)</li>
                            <li>메타 설명과 제목을 최적화하세요</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // 전역 변수로 준수도 분석 결과 저장
        let currentComplianceAnalysis = null;

        // 브라우저 확장 프로그램 충돌 방지를 위한 전역 에러 핸들러
        window.addEventListener('error', function (event) {
            if (event.error && event.error.message &&
                event.error.message.includes('message channel closed')) {
                console.warn('브라우저 확장 프로그램과의 충돌이 감지되었습니다. 무시합니다.');
                event.preventDefault();
                return false;
            }
        });

        // Promise rejection 핸들러
        window.addEventListener('unhandledrejection', function (event) {
            if (event.reason && event.reason.message &&
                event.reason.message.includes('message channel closed')) {
                console.warn('비동기 작업 중 브라우저 확장 프로그램 충돌이 감지되었습니다.');
                event.preventDefault();
                return false;
            }
        });

        // 입력 텍스트 보완 함수
        function enhanceInputText(originalText, rules, aiMode) {
            let enhancedText = originalText;
            let enhancementNotes = [];

            // SEO 최적화 옵션에 따른 보완
            if (rules.includes('AI_SEO')) {
                enhancedText += '\n\n[SEO 최적화 요구사항]\n- 주요 키워드를 제목과 본문에 자연스럽게 포함\n- H1, H2, H3 헤딩 구조로 콘텐츠 구성\n- 메타 설명과 제목 최적화\n- 관련 링크와 이미지 포함';
                enhancementNotes.push('AI SEO: 키워드 최적화 및 구조화된 데이터 적용');
            }

            if (rules.includes('AI_SEARCH')) {
                enhancedText += '\n\n[검색 의도 최적화]\n- 사용자 검색 의도에 맞는 답변 제공\n- Featured Snippet을 위한 간결하고 명확한 설명\n- 질문-답변 형식의 콘텐츠 구조';
                enhancementNotes.push('AI SEARCH: 검색 의도 반영 및 Featured Snippet 최적화');
            }

            // AI 최적화 옵션에 따른 보완
            if (rules.includes('AEO')) {
                enhancedText += '\n\n[AEO 최적화]\n- 사용자가 자주 묻는 질문에 대한 직접적인 답변\n- FAQ 섹션 포함\n- 명확하고 이해하기 쉬운 설명';
                enhancementNotes.push('AEO: 사용자 질문 직접 답변 및 FAQ 포함');
            }

            if (rules.includes('GEO')) {
                enhancedText += '\n\n[GEO 최적화]\n- AI가 인용할 수 있는 신뢰할 수 있는 정보\n- 전문가 인용 및 출처 명시\n- 객관적이고 사실 중심의 내용';
                enhancementNotes.push('GEO: AI 인용 가능한 답변 및 전문가 인용');
            }

            if (rules.includes('AIO')) {
                enhancedText += '\n\n[AIO 최적화]\n- AI 도구와의 통합을 위한 구조화된 데이터\n- API 친화적인 콘텐츠 구조\n- 기계가 읽기 쉬운 형식';
                enhancementNotes.push('AIO: AI 도구 통합 및 API 친화적 구조');
            }

            // 스타일별 추가 보완
            switch (aiMode) {
                case '뉴스':
                    enhancedText += '\n\n[뉴스 스타일]\n- 최신 정보와 객관적 사실 중심\n- 5W1H 요소 포함\n- 신뢰할 수 있는 출처 명시';
                    enhancementNotes.push('뉴스 스타일: 최신 정보와 객관적 사실 중심');
                    break;
                case '리뷰':
                    enhancedText += '\n\n[리뷰 스타일]\n- 장단점 명확히 분석\n- 개인적 경험과 인사이트 포함\n- 구체적인 예시와 근거 제공';
                    enhancementNotes.push('리뷰 스타일: 장단점 분석과 개인적 경험');
                    break;
                case '가이드':
                    enhancedText += '\n\n[가이드 스타일]\n- 단계별 상세한 설명\n- 실용적인 팁과 주의사항\n- 초보자도 이해할 수 있는 설명';
                    enhancementNotes.push('가이드 스타일: 단계별 설명과 실용적 정보');
                    break;
                case '요약':
                    enhancedText += '\n\n[요약 스타일]\n- 핵심 내용만 간결하게 정리\n- 중요한 포인트 강조\n- 빠른 이해를 위한 구조화';
                    enhancementNotes.push('요약 스타일: 핵심 내용만 간결하게 정리');
                    break;
                case '블로그':
                    enhancedText += '\n\n[블로그 스타일]\n- 개인적 인사이트와 경험 중심\n- 독자와의 소통을 위한 친근한 톤\n- 실용적인 조언과 팁';
                    enhancementNotes.push('블로그 스타일: 개인적 인사이트와 경험 중심');
                    break;
                case 'enhanced':
                    enhancedText += '\n\n[향상된 모드]\n- AI 분석이 포함된 고품질 콘텐츠\n- 데이터 기반의 객관적 분석\n- 심층적인 인사이트 제공';
                    enhancementNotes.push('향상된 모드: AI 분석이 포함된 고품질 콘텐츠');
                    break;
            }

            return {
                enhancedText: enhancedText,
                enhancementNotes: enhancementNotes
            };
        }

        // 추가 보완 사항 제안 함수
        function generateImprovementSuggestions(rules, aiMode, contentLength) {
            const suggestions = [];

            // SEO 관련 제안
            if (!rules.includes('AI_SEO')) {
                suggestions.push({
                    category: 'SEO 최적화',
                    title: 'AI SEO 적용 권장',
                    description: '키워드 최적화와 구조화된 데이터를 통해 검색 엔진 최적화를 강화할 수 있습니다.',
                    priority: 'high'
                });
            }

            if (!rules.includes('AI_SEARCH')) {
                suggestions.push({
                    category: '검색 최적화',
                    title: 'AI SEARCH 적용 권장',
                    description: '검색 의도 반영과 Featured Snippet 최적화로 검색 결과에서 더 잘 노출될 수 있습니다.',
                    priority: 'medium'
                });
            }

            // AI 최적화 관련 제안
            if (!rules.includes('AEO')) {
                suggestions.push({
                    category: '사용자 경험',
                    title: 'AEO 적용 권장',
                    description: '사용자 질문에 대한 직접적인 답변과 FAQ를 통해 사용자 만족도를 높일 수 있습니다.',
                    priority: 'high'
                });
            }

            if (!rules.includes('GEO')) {
                suggestions.push({
                    category: '신뢰성',
                    title: 'GEO 적용 권장',
                    description: 'AI가 인용할 수 있는 신뢰할 수 있는 정보로 콘텐츠의 권위를 높일 수 있습니다.',
                    priority: 'medium'
                });
            }

            if (!rules.includes('AIO')) {
                suggestions.push({
                    category: '기술적 최적화',
                    title: 'AIO 적용 권장',
                    description: 'AI 도구 통합과 API 친화적 구조로 향후 확장성을 확보할 수 있습니다.',
                    priority: 'low'
                });
            }

            // 콘텐츠 길이 관련 제안
            const targetLength = parseInt(contentLength);
            if (targetLength < 2000) {
                suggestions.push({
                    category: '콘텐츠 품질',
                    title: '콘텐츠 길이 확장 권장',
                    description: '더 상세한 정보와 예시를 추가하여 콘텐츠의 깊이와 가치를 높일 수 있습니다.',
                    priority: 'medium'
                });
            }

            // 스타일별 제안
            if (!aiMode) {
                suggestions.push({
                    category: '콘텐츠 스타일',
                    title: '콘텐츠 스타일 선택 권장',
                    description: '목적에 맞는 스타일을 선택하여 더 효과적인 콘텐츠를 생성할 수 있습니다.',
                    priority: 'medium'
                });
            }

            return suggestions;
        }

        // 결과 상태에 따른 CSS 클래스 반환 함수
        function getResultStatus(text) {
            if (text.includes('준수') || text.includes('적용') || text.includes('포함') || text.includes('최적화')) {
                return 'success';
            } else if (text.includes('부분 준수') || text.includes('일부')) {
                return 'warning';
            } else if (text.includes('미준수') || text.includes('없음')) {
                return 'danger';
            }
            return 'neutral';
        }

        // 아이콘과 텍스트를 정확히 분리하는 함수
        function extractIconAndText(text) {
            // 이모지 아이콘 패턴 (더 정확한 매칭)
            const emojiPattern = /^([\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}])/u;
            const match = text.match(emojiPattern);

            if (match) {
                const icon = match[1];
                const content = text.substring(icon.length).trim();
                return { icon, content };
            }

            // 이모지가 없는 경우 기본 아이콘 사용
            return { icon: '•', content: text };
        }

        // 문맥 기반 콘텐츠 정제화 함수
        function refineContentForReading(contentText, aiMode) {
            console.log('=== refineContentForReading 디버깅 ===');
            console.log('입력 텍스트 길이:', contentText.length);
            console.log('입력 텍스트 시작:', contentText.substring(0, 100));

            // 입력 텍스트 검증
            if (!contentText || contentText.trim().length === 0) {
                console.log('입력 텍스트가 비어있음');
                return '<p>입력된 콘텐츠가 없습니다.</p>';
            }

            // HTML 콘텐츠인지 확인
            const hasHtmlTags = /<[^>]+>/.test(contentText);

            if (hasHtmlTags) {
                // HTML 콘텐츠인 경우 그대로 반환 (마크다운 코드 블록만 제거)
                let htmlContent = removeCodeBlocks(contentText);

                console.log('HTML 콘텐츠 감지, 마크다운 블록 제거 후 길이:', htmlContent.length);
                return htmlContent;
            }

            // 일반 텍스트인 경우 기존 로직 적용
            // 불필요한 텍스트 제거
            let cleanText = contentText
                .replace(/[^\w\s가-힣.,!?;:()[\]{}"'\-–—…]/g, ' ') // 특수문자 정리
                .replace(/\s+/g, ' ') // 연속 공백 정리
                .trim();

            // 문장 단위로 분리 및 정제
            const sentences = cleanText
                .split(/[.!?]+/)
                .map(s => s.trim())
                .filter(s => s.length > 3) // 매우 관대한 길이 조건
                .map(s => {
                    // 문장 시작을 대문자로
                    if (s.length > 0) {
                        return s.charAt(0).toUpperCase() + s.slice(1);
                    }
                    return s;
                });

            // 문장이 없으면 원본 텍스트를 단순히 포맷팅
            if (sentences.length === 0) {
                return '<p>' + cleanText + '</p>';
            }

            // 문맥을 고려한 문장 재구성
            let refinedContent = '';
            let currentParagraph = '';
            let sentenceCount = 0;

            for (let i = 0; i < sentences.length; i++) {
                const sentence = sentences[i];

                // 문장이 너무 길면 분할
                if (sentence.length > 150) {
                    const parts = sentence.split(/[,;]/);
                    if (parts.length > 1) {
                        parts.forEach(part => {
                            const trimmedPart = part.trim();
                            if (trimmedPart.length > 10) {
                                currentParagraph += trimmedPart + '. ';
                                sentenceCount++;
                            }
                        });
                    } else {
                        currentParagraph += sentence + '. ';
                        sentenceCount++;
                    }
                } else {
                    currentParagraph += sentence + '. ';
                    sentenceCount++;
                }

                // 문단 구분 (3-4문장마다)
                if (sentenceCount >= 3 || i === sentences.length - 1) {
                    if (currentParagraph.trim()) {
                        refinedContent += '<p>' + currentParagraph.trim() + '</p>';
                    }
                    currentParagraph = '';
                    sentenceCount = 0;
                }
            }

            // 스타일별 추가 정제
            switch (aiMode) {
                case '뉴스':
                    // 객관적이고 사실 중심으로 정리
                    refinedContent = refinedContent
                        .replace(/[주관적|개인적|나의|저의|제 생각|개인적으로]/g, '')
                        .replace(/[확실히|분명히|틀림없이]/g, '');
                    break;
                case '리뷰':
                    // 장단점이 명확히 구분되도록 정리
                    refinedContent = refinedContent
                        .replace(/장점/g, '<strong>장점:</strong>')
                        .replace(/단점/g, '<strong>단점:</strong>')
                        .replace(/좋은 점/g, '<strong>좋은 점:</strong>')
                        .replace(/아쉬운 점/g, '<strong>아쉬운 점:</strong>');
                    break;
                case '가이드':
                    // 단계별로 명확히 구분
                    refinedContent = refinedContent
                        .replace(/(\d+\.)/g, '<strong>$1</strong>')
                        .replace(/[첫째|둘째|셋째|넷째|다섯째]/g, '<strong>$&</strong>');
                    break;
                case '요약':
                    // 핵심만 간결하게
                    refinedContent = refinedContent.replace(/<p>/g, '<p class="summary-paragraph">');
                    break;
                case '블로그':
                    // 개인적 인사이트 강조
                    refinedContent = refinedContent
                        .replace(/[중요한|핵심적인|주목할 만한|특별한|놀라운]/g, '<em>$&</em>')
                        .replace(/[경험|체험|느낀 점|배운 점]/g, '<strong>$&</strong>');
                    break;
                case 'enhanced':
                    // AI 분석이 포함된 고품질 콘텐츠
                    refinedContent = refinedContent
                        .replace(/[분석|연구|조사|결과]/g, '<strong>$&</strong>')
                        .replace(/[통계|데이터|수치]/g, '<em>$&</em>');
                    break;
            }

            // 최종 정리
            refinedContent = refinedContent
                .replace(/\s+/g, ' ') // 연속 공백 정리
                .replace(/>\s+</g, '><') // 태그 사이 공백 정리
                .trim();

            // 결과가 비어있으면 원본 텍스트를 반환
            if (!refinedContent || refinedContent.trim().length === 0) {
                return '<p>' + cleanText.substring(0, 1000) + '</p>';
            }

            return refinedContent;
        }

        // 요약(1000자 이내 완성형 문장)과 본문 분리 함수
        function extractSummaryAndBody(contentText) {
            console.log('=== extractSummaryAndBody 함수 호출됨 ===');
            console.log('입력 텍스트 길이:', contentText.length);
            console.log('입력 텍스트 시작:', contentText.substring(0, 100));

            let summary = '';
            let body = '';
            const sentences = contentText.match(/[^.!?]+[.!?]+/g) || [];
            console.log('추출된 문장 수:', sentences.length);

            // 요약: 정확히 1000자 이내 (목표: 800-1000자)
            const targetSummaryLength = Math.min(1000, Math.max(800, contentText.length * 0.3));
            let sentenceCount = 0;

            for (let s of sentences) {
                if ((summary + s).length <= targetSummaryLength && sentenceCount < 4) {
                    summary += s;
                    sentenceCount++;
                } else {
                    break;
                }
            }

            // 요약이 없거나 너무 짧으면 처음 부분을 요약으로
            if (!summary || summary.length < 300) {
                summary = contentText.substring(0, Math.min(targetSummaryLength, contentText.length));
            }

            // 본문: 요약을 제외한 나머지 전체 텍스트 (목표: 2000자 이상)
            const summaryEndIndex = contentText.indexOf(summary) + summary.length;
            body = contentText.substring(summaryEndIndex).trim();

            // 본문이 비어있거나 너무 짧으면 원본 텍스트에서 요약 부분만 제거
            if (!body || body.length < 500) {
                body = contentText.replace(summary, '').trim();
            }

            // 본문이 여전히 비어있으면 원본 텍스트를 그대로 사용하고 요약을 더 짧게
            if (!body || body.length < 300) {
                body = contentText;
                summary = contentText.substring(0, Math.min(600, contentText.length));
            }

            console.log('목표 요약 길이:', targetSummaryLength);
            console.log('실제 요약 길이:', summary.length);
            console.log('실제 본문 길이:', body.length);
            console.log('요약 시작:', summary.substring(0, 100));
            console.log('본문 시작:', body.substring(0, 100));

            return { summary: summary.trim(), body: body.trim() };
        }

        // 새로운 콘텐츠 템플릿 생성 함수
        function generateContentTemplate(data, aiMode) {
            console.log('=== generateContentTemplate 디버깅 ===');
            console.log('원본 콘텐츠 길이:', data.content.length);
            console.log('원본 콘텐츠 시작:', data.content.substring(0, 100));
            console.log('원본 콘텐츠 끝:', data.content.substring(data.content.length - 100));

            // HTML 블록에서 실제 HTML 콘텐츠만 추출
            let templateCleanContent = extractHtmlContent(data.content);

            console.log('HTML 콘텐츠 추출 완료!');
            console.log('추출된 콘텐츠 길이:', templateCleanContent.length);
            console.log('추출된 콘텐츠 시작:', templateCleanContent.substring(0, 100));

            // 만약 templateCleanContent가 비어있다면 원본 data.content 사용
            if (!templateCleanContent || templateCleanContent.trim().length === 0) {
                console.log('templateCleanContent가 비어있어서 원본 data.content 사용');
                templateCleanContent = data.content;
                console.log('원본 사용 후 길이:', templateCleanContent.length);
            }

            // 제목 추출
            const titleMatch = templateCleanContent.match(/<h1[^>]*>(.*?)<\/h1>/i);
            const title = titleMatch ? titleMatch[1] : '생성된 콘텐츠';

            // 본문 내용 추출 (H1 제외)
            console.log('=== HTML 정제 과정 디버깅 ===');
            console.log('templateCleanContent 길이:', templateCleanContent.length);
            console.log('templateCleanContent 시작:', templateCleanContent.substring(0, 200));

            // HTML 태그를 단계별로 제거하여 안전하게 처리
            let contentText = templateCleanContent;

            // 1단계: H1 태그만 제거
            contentText = contentText.replace(/<h1[^>]*>.*?<\/h1>/gi, '');
            console.log('H1 제거 후 길이:', contentText.length);

            // 2단계: 나머지 HTML 태그 제거
            contentText = contentText.replace(/<[^>]*>/g, '');
            console.log('모든 HTML 태그 제거 후 길이:', contentText.length);

            // 3단계: 공백 정리
            contentText = contentText.replace(/\s+/g, ' ').trim();
            console.log('공백 정리 후 길이:', contentText.length);
            console.log('최종 contentText 시작:', contentText.substring(0, 200));

            // 만약 contentText가 비어있다면 원본 templateCleanContent에서 H1만 제거
            if (!contentText || contentText.trim().length === 0) {
                console.log('contentText가 비어있어서 원본 templateCleanContent에서 H1만 제거');
                contentText = templateCleanContent
                    .replace(/<h1[^>]*>.*?<\/h1>/gi, '') // H1 태그만 제거
                    .replace(/\s+/g, ' ') // 연속 공백 정리
                    .trim();
                console.log('원본 사용 후 길이:', contentText.length);
            }

            // 요약/본문 분리
            console.log('=== generateContentTemplate에서 요약/본문 분리 시작 ===');
            const { summary, body } = extractSummaryAndBody(contentText);

            // 카운트
            const summaryLength = summary.length;
            const summaryWordCount = summary.split(/\s+/).filter(w => w).length;
            const bodyLength = body.length;
            const bodyWordCount = body.split(/\s+/).filter(w => w).length;

            console.log('최종 카운트 결과:');
            console.log('- 요약 길이:', summaryLength);
            console.log('- 요약 단어수:', summaryWordCount);
            console.log('- 본문 길이:', bodyLength);
            console.log('- 본문 단어수:', bodyWordCount);

            // 키워드 처리
            const keywords = data.keywords ? data.keywords.split(',').map(k => k.trim()).join(', ') : '키워드 없음';

            // 주요 내용 (본문만)
            const mainContent = refineContentForReading(body, aiMode);

            // 핵심 포인트 생성 (본문에서 문장 단위로 분리하여 3-5개 추출)
            const sentences = body.split(/[.!?]+/).filter(s => s.trim().length > 10);
            const keyPoints = sentences.slice(0, Math.min(5, sentences.length));

            // 실용적인 팁 생성 (본문에서 문장 단위로 분리하여 3-5개 추출)
            const tips = sentences.slice(Math.min(5, sentences.length), Math.min(10, sentences.length));

            // 스타일별 아이콘과 설명
            const styleInfo = {
                '뉴스': { icon: '📰', desc: '최신 정보와 객관적 사실 중심' },
                '리뷰': { icon: '⭐', desc: '장단점 분석과 개인적 경험' },
                '가이드': { icon: '📋', desc: '단계별 설명과 실용적 정보' },
                '요약': { icon: '📝', desc: '핵심 내용만 간결하게 정리' },
                '블로그': { icon: '✍️', desc: '개인적 인사이트와 경험 중심' },
                'enhanced': { icon: '🌟', desc: 'AI 분석이 포함된 고품질 콘텐츠' }
            };

            const currentStyle = styleInfo[aiMode] || { icon: '🤖', desc: '기본 스타일' };

            return `
                <div class="content-template">
                    <!-- 제목 영역 -->
                    <div class="content-header mb-4">
                        <h1 class="content-title">${title}</h1>
                        <div class="content-meta">
                            <span class="badge bg-primary me-2">${currentStyle.icon} ${aiMode || '기본'}</span>
                            <span class="text-muted">${currentStyle.desc}</span>
                        </div>
                    </div>
                    
                    <!-- 요약 -->
                    <div class="content-section mb-4">
                        <h3 class="section-title">
                            <i class="bi bi-file-text me-2"></i>요약
                            <span class="badge bg-secondary ms-2">글자수: ${summaryLength} / 단어수: ${summaryWordCount}</span>
                        </h3>
                        <div class="section-content">
                            <p class="summary-text">${summary}</p>
                        </div>
                    </div>
                    
                    <!-- 추천 키워드 -->
                    <div class="content-section mb-4">
                        <h3 class="section-title">
                            <i class="bi bi-tags me-2"></i>추천 키워드
                        </h3>
                        <div class="section-content">
                            <div class="keywords-display">
                                ${keywords.split(',').map(k => `<span class="keyword-tag">${k.trim()}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 주요 내용 -->
                    <div class="content-section mb-4">
                        <h3 class="section-title">
                            <i class="bi bi-file-earmark-text me-2"></i>주요 내용
                            <span class="badge bg-secondary ms-2">글자수: ${bodyLength} / 단어수: ${bodyWordCount}</span>
                        </h3>
                        <div class="section-content">
                            <div class="main-content-text">
                                ${mainContent}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 핵심 포인트 -->
                    <div class="content-section mb-4">
                        <h3 class="section-title">
                            <i class="bi bi-lightbulb me-2"></i>핵심 포인트
                        </h3>
                        <div class="section-content">
                            <ul class="key-points-list">
                                ${keyPoints.map(point => `<li>${point.trim()}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <!-- 실용적인 팁 -->
                    <div class="content-section mb-4">
                        <h3 class="section-title">
                            <i class="bi bi-lightning me-2"></i>실용적인 팁
                        </h3>
                        <div class="section-content">
                            <ul class="tips-list">
                                ${tips.map((tip, index) => `<li>${tip.trim()}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <!-- 구분선 -->
                    <hr class="content-divider">
                    
                    <!-- AI 분석 -->
                    <div class="content-section ai-analysis-section">
                        <h3 class="section-title">
                            <i class="bi bi-robot me-2"></i>AI 분석
                        </h3>
                        <div class="section-content">
                            <div class="ai-analysis-content">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="ai-analysis-card">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h5 class="ai-analysis-title mb-0">신뢰도 평가</h5>
                                                <button class="btn btn-sm btn-outline-info" onclick="showAnalysisHelp('trust')" title="근거 자료 보기">
                                                    <i class="bi bi-question-circle"></i>
                                                </button>
                                            </div>
                                            <div class="ai-analysis-value" id="trust-score-container">-</div>
                                            <div class="ai-analysis-desc" id="trust-reason-container">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="ai-analysis-card">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h5 class="ai-analysis-title mb-0">SEO 최적화 점수</h5>
                                                <button class="btn btn-sm btn-outline-info" onclick="showAnalysisHelp('seo')" title="근거 자료 보기">
                                                    <i class="bi bi-question-circle"></i>
                                                </button>
                                            </div>
                                            <div class="ai-analysis-value" id="seo-score-container">-</div>
                                            <div class="ai-analysis-desc" id="seo-reason-container">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="ai-analysis-card">
                                            <h5 class="ai-analysis-title">AI 요약</h5>
                                            <div class="ai-analysis-desc" id="ai-summary-container">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function displayGuidelinesCompliance(content, config) {
            // 콘텐츠 카드를 확장 상태로 변경
            const resultContainer = document.getElementById('result-container');
            resultContainer.classList.add('expanded');
            const guidelinesSummary = document.getElementById('guidelines-summary');
            const configuredGuidelines = document.getElementById('configured-guidelines');
            const appliedResults = document.getElementById('applied-results');
            const complianceScore = document.getElementById('guidelines-compliance-score');
            const complianceProgress = document.getElementById('compliance-progress');
            const compliancePercentage = document.getElementById('compliance-percentage');

            let complianceAnalysis = [];
            let complianceCount = 0;
            let totalChecks = 0;

            // AI SEO 규칙 준수도 확인
            if (config.rules.includes('AI_SEO')) {
                totalChecks++;
                const hasKeywords = content.includes('<h1') || content.includes('<h2') || content.includes('<strong>');
                const hasStructuredData = content.includes('itemscope') || content.includes('schema.org');

                if (hasKeywords && hasStructuredData) {
                    complianceAnalysis.push('<span class="badge bg-success me-1 mb-1">✅ AI SEO 완벽 준수</span>');
                    complianceCount++;
                } else if (hasKeywords || hasStructuredData) {
                    complianceAnalysis.push('<span class="badge bg-warning me-1 mb-1">⚠️ AI SEO 부분 준수</span>');
                    complianceCount += 0.5;
                } else {
                    complianceAnalysis.push('<span class="badge bg-danger me-1 mb-1">❌ AI SEO 미준수</span>');
                }
            }

            // AEO 규칙 준수도 확인
            if (config.rules.includes('AEO')) {
                totalChecks++;
                const hasFAQ = content.includes('FAQ') || content.includes('자주 묻는 질문') || content.includes('Q&A');
                const hasQuestions = content.includes('?') && (content.includes('답변') || content.includes('답'));

                if (hasFAQ || hasQuestions) {
                    complianceAnalysis.push('<span class="badge bg-success me-1 mb-1">✅ AEO 완벽 준수</span>');
                    complianceCount++;
                } else {
                    complianceAnalysis.push('<span class="badge bg-danger me-1 mb-1">❌ AEO 미준수</span>');
                }
            }

            // GEO 규칙 준수도 확인
            if (config.rules.includes('GEO')) {
                totalChecks++;
                const hasCitations = content.includes('출처') || content.includes('참고') || content.includes('인용');
                const hasTrustElements = content.includes('신뢰') || content.includes('검증') || content.includes('확인');

                if (hasCitations && hasTrustElements) {
                    complianceAnalysis.push('<span class="badge bg-success me-1 mb-1">✅ GEO 완벽 준수</span>');
                    complianceCount++;
                } else if (hasCitations || hasTrustElements) {
                    complianceAnalysis.push('<span class="badge bg-warning me-1 mb-1">⚠️ GEO 부분 준수</span>');
                    complianceCount += 0.5;
                } else {
                    complianceAnalysis.push('<span class="badge bg-danger me-1 mb-1">❌ GEO 미준수</span>');
                }
            }

            // 콘텐츠 길이 준수도 확인 (H1, H2, H3, H4 태그 제외)
            if (config.contentLength) {
                totalChecks++;
                const complianceCleanContent = removeCodeBlocks(content)
                    .replace(/<h[1-4][^>]*>.*?<\/h[1-4]>/gi, '') // H1-H4 태그와 내용 제거
                    .replace(/<[^>]*>/g, '') // 나머지 HTML 태그 제거
                    .replace(/\s+/g, ' ') // 연속 공백을 단일 공백으로
                    .trim(); // 앞뒤 공백 제거
                const contentLength = complianceCleanContent.length;
                const targetLength = parseInt(config.contentLength);
                const lengthRatio = contentLength / targetLength;

                if (lengthRatio >= 0.8 && lengthRatio <= 1.2) {
                    complianceAnalysis.push(`<span class="badge bg-success me-1 mb-1">✅ 길이 준수 (${contentLength}자)</span>`);
                    complianceCount++;
                } else if (lengthRatio >= 0.6 && lengthRatio <= 1.4) {
                    complianceAnalysis.push(`<span class="badge bg-warning me-1 mb-1">⚠️ 길이 부분 준수 (${contentLength}자)</span>`);
                    complianceCount += 0.5;
                } else {
                    complianceAnalysis.push(`<span class="badge bg-danger me-1 mb-1">❌ 길이 미준수 (${contentLength}자)</span>`);
                }
            }

            // 정책 균형 준수도 확인
            if (config.policyAuto) {
                totalChecks++;
                const hasBalance = content.includes('장단점') || content.includes('고려사항') ||
                    content.includes('주의사항') || content.includes('단점') ||
                    content.includes('한계') || content.includes('문제점');

                if (hasBalance) {
                    complianceAnalysis.push('<span class="badge bg-success me-1 mb-1">✅ 정책 균형 준수</span>');
                    complianceCount++;
                } else {
                    complianceAnalysis.push('<span class="badge bg-danger me-1 mb-1">❌ 정책 균형 미준수</span>');
                }
            }

            // AI 모드 준수도 확인
            if (config.aiMode) {
                totalChecks++;
                let modeCompliance = false;

                switch (config.aiMode) {
                    case '뉴스':
                        modeCompliance = content.includes('최신') || content.includes('발표') || content.includes('공개');
                        break;
                    case '리뷰':
                        modeCompliance = content.includes('장점') || content.includes('단점') || content.includes('평가');
                        break;
                    case '가이드':
                        modeCompliance = content.includes('단계') || content.includes('방법') || content.includes('순서');
                        break;
                    case '요약':
                        modeCompliance = content.length < 2000; // 요약은 짧아야 함
                        break;
                    case '블로그':
                        modeCompliance = content.includes('개인') || content.includes('경험') || content.includes('생각');
                        break;
                }

                if (modeCompliance) {
                    complianceAnalysis.push(`<span class="badge bg-success me-1 mb-1">✅ ${config.aiMode} 스타일 준수</span>`);
                    complianceCount++;
                } else {
                    complianceAnalysis.push(`<span class="badge bg-warning me-1 mb-1">⚠️ ${config.aiMode} 스타일 부분 준수</span>`);
                    complianceCount += 0.5;
                }
            }

            // 준수도 계산 및 표시
            if (totalChecks > 0) {
                const complianceRate = Math.round((complianceCount / totalChecks) * 100);

                // 준수도 분석 결과 저장
                currentComplianceAnalysis = {
                    rate: complianceRate,
                    totalChecks: totalChecks,
                    complianceCount: complianceCount,
                    analysis: complianceAnalysis,
                    config: config,
                    content: content
                };

                // 준수도 표시 업데이트
                complianceScore.textContent = `준수도: ${complianceRate}%`;
                complianceProgress.style.width = `${complianceRate}%`;
                compliancePercentage.textContent = `${complianceRate}%`;

                // 준수도에 따른 색상 변경
                if (complianceRate >= 80) {
                    complianceScore.className = 'badge compliance-score bg-success me-2';
                    complianceProgress.className = 'progress-bar bg-success';
                } else if (complianceRate >= 60) {
                    complianceScore.className = 'badge compliance-score bg-warning me-2';
                    complianceProgress.className = 'progress-bar bg-warning';
                } else {
                    complianceScore.className = 'badge compliance-score bg-danger me-2';
                    complianceProgress.className = 'progress-bar bg-danger';
                }

                // 설정된 가이드라인 표시 업데이트
                if (configuredGuidelines) {
                    const configItems = [];

                    // 규칙들을 아이콘과 함께 표시
                    if (config.rules.length > 0) {
                        const ruleIcons = {
                            'AI_SEO': '🤖',
                            'AI_SEARCH': '🔍',
                            'AEO': '💬',
                            'GEO': '🌐',
                            'AIO': '🔧'
                        };
                        const ruleDisplay = config.rules.map(rule =>
                            `<span class="guideline-badge">${ruleIcons[rule] || '⚙️'} ${rule.replace('_', ' ')}</span>`
                        ).join('');
                        configItems.push(`<div class="guideline-section"><strong>규칙:</strong> ${ruleDisplay}</div>`);
                    }

                    // AI 모드 표시
                    if (config.aiMode) {
                        const modeIcons = {
                            '뉴스': '📰',
                            '리뷰': '⭐',
                            '가이드': '📋',
                            '요약': '📝',
                            '블로그': '✍️',
                            'enhanced': '🌟'
                        };
                        const modeIcon = modeIcons[config.aiMode] || '🤖';
                        configItems.push(`<div class="guideline-section"><strong>스타일:</strong> <span class="guideline-badge">${modeIcon} ${config.aiMode}</span></div>`);
                    }

                    // 목표 길이 표시
                    if (config.contentLength) {
                        configItems.push(`<div class="guideline-section"><strong>목표:</strong> <span class="guideline-badge">📏 ${config.contentLength}자</span></div>`);
                    }

                    // 정책 균형 표시
                    if (config.policyAuto) {
                        configItems.push(`<div class="guideline-section"><strong>균형:</strong> <span class="guideline-badge">⚖️ 자동 적용</span></div>`);
                    }

                    configuredGuidelines.innerHTML = configItems.join('');
                }

                // 적용 결과 표시 업데이트
                if (appliedResults) {
                    const resultItems = complianceAnalysis.map(result => {
                        const text = result.replace(/<[^>]*>/g, '');
                        const isSuccess = result.includes('bg-success');
                        const isWarning = result.includes('bg-warning');
                        const isDanger = result.includes('bg-danger');

                        let statusIcon = '❓';
                        let statusClass = 'result-neutral';

                        if (isSuccess) {
                            statusIcon = '✅';
                            statusClass = 'result-success';
                        } else if (isWarning) {
                            statusIcon = '⚠️';
                            statusClass = 'result-warning';
                        } else if (isDanger) {
                            statusIcon = '❌';
                            statusClass = 'result-danger';
                        }

                        return `<div class="result-item ${statusClass}">
                            <span class="result-icon">${statusIcon}</span>
                            <span class="result-text">${text}</span>
                        </div>`;
                    }).join('');

                    appliedResults.innerHTML = resultItems || '<div class="text-muted">분석 결과가 없습니다.</div>';
                }

                // 가이드라인 요약 표시
                if (guidelinesSummary) {
                    guidelinesSummary.style.display = 'block';
                }
            }
        }

        function showComplianceGuide() {
            if (!currentComplianceAnalysis) {
                showAlert('info', '준수도 분석 결과가 없습니다. 먼저 콘텐츠를 생성해주세요.');
                return;
            }

            const analysis = currentComplianceAnalysis;
            const guideContent = document.getElementById('compliance-guide-content');
            const modalElement = document.getElementById('complianceGuideModal');

            let guideHTML = `
                <div class="row">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle me-2"></i>현재 준수도: ${analysis.rate}%</h6>
                            <p class="mb-0">총 ${analysis.totalChecks}개 항목 중 ${analysis.complianceCount}개 항목이 준수되었습니다.</p>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-graph-up me-2"></i>준수도 구간별 분석
                        </h6>
                        ${getComplianceLevelAnalysis(analysis.rate)}
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-success mb-3">
                            <i class="bi bi-check-circle me-2"></i>개선 제안사항
                        </h6>
                        ${getImprovementSuggestions(analysis)}
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-warning mb-3">
                            <i class="bi bi-lightbulb me-2"></i>글 작성 팁
                        </h6>
                        ${getWritingTips(analysis)}
                    </div>
                </div>
            `;

            guideContent.innerHTML = guideHTML;

            // 모달 표시 (접근성 개선)
            try {
                const modal = new bootstrap.Modal(modalElement);

                // 모달 이벤트 리스너 추가
                modalElement.addEventListener('shown.bs.modal', function () {
                    // 모달이 표시된 후 포커스 관리
                    const applyBtn = document.getElementById('applySuggestionsBtn');
                    if (applyBtn) {
                        applyBtn.focus();
                    }
                });

                modalElement.addEventListener('hidden.bs.modal', function () {
                    // 모달이 닫힌 후 포커스 복원
                    const generateBtn = document.getElementById('generate-btn');
                    if (generateBtn) {
                        generateBtn.focus();
                    }
                });

                modal.show();
            } catch (error) {
                console.error('모달 표시 중 오류:', error);
                showAlert('danger', '모달을 표시할 수 없습니다.');
            }
        }

        function getComplianceLevelAnalysis(rate) {
            if (rate >= 90) {
                return `
                    <div class="alert alert-success">
                        <h6><i class="bi bi-trophy me-2"></i>우수 (90-100%)</h6>
                        <p class="mb-2">매우 높은 준수도입니다! 대부분의 가이드라인이 잘 적용되었습니다.</p>
                        <ul class="mb-0">
                            <li>콘텐츠 품질이 매우 우수합니다</li>
                            <li>SEO 최적화가 잘 되어 있습니다</li>
                            <li>독자에게 높은 가치를 제공합니다</li>
                        </ul>
                    </div>
                `;
            } else if (rate >= 80) {
                return `
                    <div class="alert alert-info">
                        <h6><i class="bi bi-star me-2"></i>양호 (80-89%)</h6>
                        <p class="mb-2">좋은 준수도입니다. 몇 가지 개선사항이 있습니다.</p>
                        <ul class="mb-0">
                            <li>전반적으로 잘 작성된 콘텐츠입니다</li>
                            <li>일부 세부사항만 보완하면 됩니다</li>
                            <li>독자 경험이 양호합니다</li>
                        </ul>
                    </div>
                `;
            } else if (rate >= 70) {
                return `
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle me-2"></i>보통 (70-79%)</h6>
                        <p class="mb-2">적당한 준수도입니다. 개선이 필요한 부분이 있습니다.</p>
                        <ul class="mb-0">
                            <li>기본적인 구조는 갖추고 있습니다</li>
                            <li>몇 가지 중요한 요소가 부족합니다</li>
                            <li>개선을 통해 더 나은 결과를 얻을 수 있습니다</li>
                        </ul>
                    </div>
                `;
            } else if (rate >= 60) {
                return `
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle me-2"></i>미흡 (60-69%)</h6>
                        <p class="mb-2">준수도가 낮습니다. 상당한 개선이 필요합니다.</p>
                        <ul class="mb-0">
                            <li>기본 구조는 있지만 세부사항이 부족합니다</li>
                            <li>SEO 최적화가 미흡합니다</li>
                            <li>독자 경험을 개선할 필요가 있습니다</li>
                        </ul>
                    </div>
                `;
            } else {
                return `
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-x-circle me-2"></i>부족 (60% 미만)</h6>
                        <p class="mb-2">준수도가 매우 낮습니다. 대폭적인 개선이 필요합니다.</p>
                        <ul class="mb-0">
                            <li>기본적인 가이드라인 준수가 부족합니다</li>
                            <li>SEO 최적화가 거의 되어 있지 않습니다</li>
                            <li>전면적인 재작성이 권장됩니다</li>
                        </ul>
                    </div>
                `;
            }
        }

        function getImprovementSuggestions(analysis) {
            const suggestions = [];
            const config = analysis.config;
            const content = analysis.content;

            // AI SEO 개선 제안
            if (config.rules.includes('AI_SEO')) {
                if (!content.includes('<h1') && !content.includes('<h2')) {
                    suggestions.push({
                        category: 'AI SEO',
                        issue: '헤딩 구조 부족',
                        suggestion: 'H1, H2, H3 태그를 사용하여 계층적 구조를 만드세요.',
                        priority: '높음',
                        action: 'addHeadings',
                        actionText: '헤딩 구조 추가'
                    });
                }
                if (!content.includes('itemscope') && !content.includes('schema.org')) {
                    suggestions.push({
                        category: 'AI SEO',
                        issue: '구조화된 데이터 없음',
                        suggestion: 'Schema.org 마크업을 추가하여 검색엔진이 콘텐츠를 더 잘 이해할 수 있도록 하세요.',
                        priority: '중간',
                        action: 'addStructuredData',
                        actionText: '구조화 데이터 추가'
                    });
                }
            }

            // AEO 개선 제안
            if (config.rules.includes('AEO')) {
                if (!content.includes('FAQ') && !content.includes('자주 묻는 질문')) {
                    suggestions.push({
                        category: 'AEO',
                        issue: 'FAQ 섹션 부족',
                        suggestion: '독자들이 자주 묻는 질문과 답변을 포함한 FAQ 섹션을 추가하세요.',
                        priority: '높음',
                        action: 'addFAQ',
                        actionText: 'FAQ 섹션 추가'
                    });
                }
            }

            // GEO 개선 제안
            if (config.rules.includes('GEO')) {
                if (!content.includes('출처') && !content.includes('참고')) {
                    suggestions.push({
                        category: 'GEO',
                        issue: '출처 인용 부족',
                        suggestion: '신뢰할 수 있는 출처를 인용하여 콘텐츠의 신뢰성을 높이세요.',
                        priority: '중간',
                        action: 'addSources',
                        actionText: '출처 인용 추가'
                    });
                }
            }

            // 콘텐츠 길이 개선 제안
            if (config.contentLength) {
                const contentLength = content.replace(/<[^>]*>/g, '').length;
                const targetLength = parseInt(config.contentLength);
                if (contentLength < targetLength * 0.8) {
                    suggestions.push({
                        category: '콘텐츠 길이',
                        issue: '목표 길이 미달',
                        suggestion: `목표 길이 ${targetLength}자에 비해 현재 ${contentLength}자로 부족합니다. 더 상세한 내용을 추가하세요.`,
                        priority: '높음',
                        action: 'expandContent',
                        actionText: '콘텐츠 확장'
                    });
                }
            }

            // 정책 균형 개선 제안
            if (config.policyAuto) {
                if (!content.includes('장단점') && !content.includes('고려사항')) {
                    suggestions.push({
                        category: '정책 균형',
                        issue: '균형 잡힌 관점 부족',
                        suggestion: '장단점, 고려사항, 주의사항 등을 포함하여 균형 잡힌 관점을 제시하세요.',
                        priority: '중간',
                        action: 'addBalance',
                        actionText: '균형 관점 추가'
                    });
                }
            }

            if (suggestions.length === 0) {
                return '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>모든 가이드라인이 잘 준수되었습니다!</div>';
            }

            let suggestionsHTML = '';
            suggestions.forEach((suggestion, index) => {
                const priorityColor = suggestion.priority === '높음' ? 'danger' : 'warning';
                suggestionsHTML += `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title text-${priorityColor}">
                                        <i class="bi bi-exclamation-triangle me-2"></i>${suggestion.category}
                                    </h6>
                                    <p class="card-text mb-1"><strong>문제:</strong> ${suggestion.issue}</p>
                                    <p class="card-text mb-0"><strong>제안:</strong> ${suggestion.suggestion}</p>
                                </div>
                                <div class="d-flex flex-column align-items-end">
                                    <span class="badge bg-${priorityColor} mb-2">${suggestion.priority}</span>
                                    <button type="button" class="btn btn-sm btn-outline-primary" 
                                            onclick="applySuggestion(${index}, '${suggestion.action}', '${suggestion.category}')">
                                        <i class="bi bi-magic me-1"></i>${suggestion.actionText}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            // 전역 변수에 제안사항 저장
            window.currentSuggestions = suggestions;

            return suggestionsHTML;
        }

        function getWritingTips(analysis) {
            const tips = [
                {
                    title: '제목 최적화',
                    tip: 'H1 태그에는 주요 키워드를 포함하고, H2, H3 태그로 하위 주제를 구분하세요.'
                },
                {
                    title: '키워드 배치',
                    tip: '첫 문단, 마지막 문단, 그리고 본문 중간에 자연스럽게 키워드를 배치하세요.'
                },
                {
                    title: '가독성 향상',
                    tip: '짧은 문단, 글머리 기호, 번호 매기기를 사용하여 읽기 쉽게 만드세요.'
                },
                {
                    title: '내부 링크',
                    tip: '관련된 다른 페이지나 섹션으로의 링크를 추가하여 사용자 경험을 향상시키세요.'
                },
                {
                    title: '이미지 최적화',
                    tip: '관련 이미지를 추가하고 alt 텍스트에 키워드를 포함하세요.'
                }
            ];

            let tipsHTML = '<div class="row">';
            tips.forEach((tip, index) => {
                tipsHTML += `
                    <div class="col-md-6 mb-2">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-primary">
                                    <i class="bi bi-lightbulb me-2"></i>${tip.title}
                                </h6>
                                <p class="card-text small">${tip.tip}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            tipsHTML += '</div>';

            return tipsHTML;
        }

        // 개별 제안사항 적용 함수
        async function applySuggestion(index, action, category) {
            try {
                const suggestion = window.currentSuggestions[index];
                if (!suggestion) {
                    showAlert('danger', '제안사항을 찾을 수 없습니다.');
                    return;
                }

                showAlert('info', `${category} 개선사항을 적용하고 있습니다...`);

                // 현재 생성된 콘텐츠 가져오기
                const currentContent = document.getElementById('generated-content').value;
                if (!currentContent) {
                    showAlert('danger', '적용할 콘텐츠가 없습니다.');
                    return;
                }

                // 제안사항에 따른 콘텐츠 개선
                const improvedContent = await improveContentWithSuggestion(currentContent, action, suggestion);

                if (improvedContent) {
                    // 개선된 콘텐츠를 에디터에 반영
                    document.getElementById('generated-content').value = improvedContent;

                    // 콘텐츠 미리보기 업데이트
                    updateContentPreview(improvedContent);

                    showAlert('success', `${category} 개선사항이 성공적으로 적용되었습니다!`);

                    // 적용된 제안사항 버튼 비활성화
                    const button = event.target.closest('.btn');
                    if (button) {
                        button.disabled = true;
                        button.innerHTML = '<i class="bi bi-check-circle me-1"></i>적용됨';
                        button.classList.remove('btn-outline-primary');
                        button.classList.add('btn-success');
                    }
                } else {
                    showAlert('danger', '콘텐츠 개선에 실패했습니다.');
                }
            } catch (error) {
                console.error('제안사항 적용 중 오류:', error);
                showAlert('danger', '제안사항 적용 중 오류가 발생했습니다.');
            }
        }

        // 제안사항에 따른 콘텐츠 개선 함수
        async function improveContentWithSuggestion(content, action, suggestion) {
            try {
                const requestData = {
                    content: content,
                    action: action,
                    suggestion: suggestion,
                    keywords: getCurrentKeywords()
                };

                const response = await fetch('/api/v1/improve-content-suggestion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                return result.improved_content;
            } catch (error) {
                console.error('콘텐츠 개선 요청 중 오류:', error);

                // API 호출 실패 시 로컬 개선 시도
                return applyLocalImprovement(content, action, suggestion);
            }
        }

        // 로컬 개선 함수 (API 실패 시 대체)
        function applyLocalImprovement(content, action, suggestion) {
            let improvedContent = content;

            switch (action) {
                case 'addHeadings':
                    improvedContent = addHeadingsToContent(content);
                    break;
                case 'addFAQ':
                    improvedContent = addFAQToContent(content);
                    break;
                case 'addSources':
                    improvedContent = addSourcesToContent(content);
                    break;
                case 'expandContent':
                    improvedContent = expandContent(content);
                    break;
                case 'addBalance':
                    improvedContent = addBalanceToContent(content);
                    break;
                case 'addStructuredData':
                    improvedContent = addStructuredDataToContent(content);
                    break;
                default:
                    return content;
            }

            return improvedContent;
        }

        // 헤딩 구조 추가
        function addHeadingsToContent(content) {
            const htmlMatch = content.match(/```html\s*([\s\S]*?)\s*```/i);
            if (!htmlMatch) return content;

            let htmlContent = htmlMatch[1];

            // 첫 번째 p 태그를 h2로 변경
            htmlContent = htmlContent.replace(/<p>([^<]+)<\/p>/i, '<h2>$1</h2>');

            // 주요 섹션에 h3 태그 추가
            htmlContent = htmlContent.replace(/<p><strong>([^<]+)<\/strong>/g, '<h3>$1</h3>');

            return content.replace(htmlMatch[0], '```html\n' + htmlContent + '\n```');
        }

        // FAQ 섹션 추가
        function addFAQToContent(content) {
            const htmlMatch = content.match(/```html\s*([\s\S]*?)\s*```/i);
            if (!htmlMatch) return content;

            let htmlContent = htmlMatch[1];

            const faqSection =
                '<h2>자주 묻는 질문 (FAQ)</h2>' +
                '<div class="faq-section">' +
                '<h3>Q: 이 주제에 대해 가장 많이 묻는 질문은 무엇인가요?</h3>' +
                '<p>A: 이 주제에 대해 독자들이 가장 궁금해하는 부분에 대한 답변을 제공합니다.</p>' +
                '<h3>Q: 실제 적용 시 주의사항은 무엇인가요?</h3>' +
                '<p>A: 실제 사용 시 고려해야 할 중요한 사항들을 안내합니다.</p>' +
                '<h3>Q: 추가로 알아두면 좋은 정보는 무엇인가요?</h3>' +
                '<p>A: 더 깊이 있는 이해를 위한 추가 정보를 제공합니다.</p>' +
                '</div>';

            // 결론 섹션 앞에 FAQ 추가
            htmlContent = htmlContent.replace(/<h2>결론<\/h2>/i, faqSection + '\n\n<h2>결론</h2>');

            return content.replace(htmlMatch[0], '```html\n' + htmlContent + '\n```');
        }

        // 출처 인용 추가
        function addSourcesToContent(content) {
            const htmlMatch = content.match(/```html\s*([\s\S]*?)\s*```/i);
            if (!htmlMatch) return content;

            let htmlContent = htmlMatch[1];

            const sourcesSection =
                '<h2>참고 자료</h2>' +
                '<ul>' +
                '<li><a href="#" target="_blank" rel="noopener noreferrer">관련 연구 자료</a></li>' +
                '<li><a href="#" target="_blank" rel="noopener noreferrer">전문가 의견</a></li>' +
                '<li><a href="#" target="_blank" rel="noopener noreferrer">공식 문서</a></li>' +
                '</ul>';

            // 결론 섹션 앞에 출처 추가
            htmlContent = htmlContent.replace(/<h2>결론<\/h2>/i, sourcesSection + '\n\n<h2>결론</h2>');

            return content.replace(htmlMatch[0], '```html\n' + htmlContent + '\n```');
        }

        // 콘텐츠 확장
        function expandContent(content) {
            const htmlMatch = content.match(/```html\s*([\s\S]*?)\s*```/i);
            if (!htmlMatch) return content;

            let htmlContent = htmlMatch[1];

            // 각 섹션에 더 상세한 내용 추가
            htmlContent = htmlContent.replace(/<p>([^<]+)<\/p>/g, (match, text) => {
                if (text.length < 100) {
                    return `<p>${text}</p><p>이에 대한 추가적인 설명과 구체적인 예시를 통해 더 깊이 있는 이해를 돕습니다. 실제 적용 사례와 함께 단계별 가이드를 제공하여 독자들이 쉽게 따라할 수 있도록 구성했습니다.</p>`;
                }
                return match;
            });

            return content.replace(htmlMatch[0], `\`\`\`html\n${htmlContent}\n\`\`\``);
        }

        // 균형 잡힌 관점 추가
        function addBalanceToContent(content) {
            const htmlMatch = content.match(/```html\s*([\s\S]*?)\s*```/i);
            if (!htmlMatch) return content;

            let htmlContent = htmlMatch[1];

            const balanceSection = `
                <h2>고려사항 및 주의사항</h2>
                <div class="balance-section">
                    <h3>장점</h3>
                    <ul>
                        <li>효과적인 결과를 얻을 수 있습니다</li>
                        <li>시간과 비용을 절약할 수 있습니다</li>
                        <li>체계적인 접근이 가능합니다</li>
                    </ul>
                    
                    <h3>단점 및 주의사항</h3>
                    <ul>
                        <li>초기 설정에 시간이 필요할 수 있습니다</li>
                        <li>지속적인 모니터링이 필요합니다</li>
                        <li>시장 변화에 따른 조정이 필요할 수 있습니다</li>
                    </ul>
                </div>
            `;

            // 결론 섹션 앞에 균형 섹션 추가
            htmlContent = htmlContent.replace(/<h2>결론<\/h2>/i, `${balanceSection}\n\n<h2>결론</h2>`);

            return content.replace(htmlMatch[0], `\`\`\`html\n${htmlContent}\n\`\`\``);
        }

        // 구조화 데이터 추가
        function addStructuredDataToContent(content) {
            const htmlMatch = content.match(/```html\s*([\s\S]*?)\s*```/i);
            if (!htmlMatch) return content;

            let htmlContent = htmlMatch[1];

            // JSON-LD 구조화 데이터 추가 (JavaScript 실행을 피하기 위해 문자열로 처리)
            const currentDate = new Date().toISOString();
            const structuredData =
                '<script type="application/ld+json">' +
                '{' +
                '"@context": "https://schema.org",' +
                '"@type": "Article",' +
                '"headline": "페이지 제목",' +
                '"description": "페이지 설명",' +
                '"author": {' +
                '"@type": "Person",' +
                '"name": "작성자"' +
                '},' +
                '"publisher": {' +
                '"@type": "Organization",' +
                '"name": "발행처"' +
                '},' +
                '"datePublished": "' + currentDate + '",' +
                '"dateModified": "' + currentDate + '"' +
                '}' +
                '<\\/script>';

            // head 태그가 있으면 그 안에, 없으면 body 시작 부분에 추가
            if (htmlContent.includes('<head>')) {
                htmlContent = htmlContent.replace(/<head>/i, '<head>' + structuredData);
            } else {
                htmlContent = structuredData + htmlContent;
            }

            return content.replace(htmlMatch[0], '```html\n' + htmlContent + '\n```');
        }

        // 현재 키워드 가져오기
        function getCurrentKeywords() {
            const keywordsInput = document.getElementById('keywords');
            return keywordsInput ? keywordsInput.value : '';
        }

        // 콘텐츠 미리보기 업데이트 함수
        function updateContentPreview(content) {
            const previewElement = document.getElementById('content-preview');
            if (previewElement && content) {
                // HTML 블록에서 실제 콘텐츠 추출
                const htmlMatch = content.match(/```html\s*([\s\S]*?)\s*```/i);
                if (htmlMatch) {
                    previewElement.innerHTML = htmlMatch[1];
                } else {
                    previewElement.innerHTML = content;
                }
            }
        }

        // 현재 생성된 콘텐츠를 저장할 전역 변수
        let currentGeneratedContent = null;

        function applyComplianceSuggestions() {
            if (!currentComplianceAnalysis) {
                showAlert('info', '적용할 준수도 분석 결과가 없습니다.');
                return;
            }

            try {
                // 모달 닫기 (안전한 방식)
                const modalElement = document.getElementById('complianceGuideModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }

                // 개선 제안 적용 시작
                showAlert('info', '개선 제안을 적용하여 콘텐츠를 업데이트하고 있습니다...');

                // 메시지 채널 충돌 방지를 위한 지연 처리
                setTimeout(() => {
                    improveContentWithSuggestions().catch(error => {
                        console.error('콘텐츠 개선 중 오류:', error);
                        if (error.name !== 'AbortError') {
                            showAlert('danger', '콘텐츠 개선 중 오류가 발생했습니다: ' + error.message);
                        }
                    });
                }, 200);

            } catch (error) {
                console.error('준수도 제안 적용 중 오류:', error);
                showAlert('danger', '준수도 제안 적용 중 오류가 발생했습니다.');
            }
        }

        async function improveContentWithSuggestions() {
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressMessage = document.getElementById('progress-message');

            // 진행 상황 표시 (null 체크 포함)
            if (progressContainer) {
                progressContainer.style.display = 'block';
                if (progressBar) {
                    progressBar.style.width = '25%';
                }
                if (progressMessage) {
                    progressMessage.textContent = '개선 제안 분석 중...';
                }
            }

            try {
                // 개선 제안 생성
                const suggestions = generateImprovementSuggestions(currentComplianceAnalysis);

                if (progressContainer) {
                    if (progressBar) {
                        progressBar.style.width = '50%';
                    }
                    if (progressMessage) {
                        progressMessage.textContent = '콘텐츠 개선 중...';
                    }
                }

                // AI를 통한 콘텐츠 개선 (AbortController 사용)
                const improvementResult = await improveContentWithAI(currentGeneratedContent, suggestions);

                if (progressContainer) {
                    if (progressBar) {
                        progressBar.style.width = '75%';
                    }
                    if (progressMessage) {
                        progressMessage.textContent = '개선된 콘텐츠 적용 중...';
                    }
                }

                // 개선된 콘텐츠로 UI 업데이트
                updateContentWithImprovements(improvementResult.improved_content, improvementResult);

                if (progressContainer) {
                    if (progressBar) {
                        progressBar.style.width = '100%';
                    }
                    if (progressMessage) {
                        progressMessage.textContent = '개선 완료!';
                    }

                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 2000);
                }

                // 성공 메시지 표시
                if (improvementResult.fallback) {
                    showAlert('warning', 'AI 개선이 실패하여 로컬 개선을 적용했습니다.');
                } else {
                    showAlert('success', '콘텐츠가 개선 제안에 따라 업데이트되었습니다!');
                }

            } catch (error) {
                console.error('콘텐츠 개선 중 오류:', error);

                // 진행 상황 숨기기
                if (progressContainer) {
                    progressContainer.style.display = 'none';
                }

                // 사용자에게 오류 알림
                if (error.name === 'AbortError') {
                    showAlert('warning', '요청 시간이 초과되어 로컬 개선을 적용했습니다.');
                } else {
                    showAlert('danger', '콘텐츠 개선 중 오류가 발생했습니다: ' + error.message);
                }
            }
        }

        function generateImprovementSuggestions(analysis) {
            const suggestions = [];

            // 길이 관련 제안
            if (analysis.contentLength < 1500) {
                suggestions.push({
                    type: 'length',
                    priority: '높음',
                    title: '콘텐츠 길이 부족',
                    description: '콘텐츠 길이가 부족합니다. 더 상세한 설명과 예시를 추가하세요.',
                    action: 'expand_content'
                });
            }

            // AI SEO 관련 제안
            if (!analysis.aiSeoCompliance) {
                suggestions.push({
                    type: 'ai_seo',
                    priority: '높음',
                    title: 'AI SEO 최적화 부족',
                    description: 'AI SEO 최적화가 부족합니다. 키워드 밀도와 구조를 개선하세요.',
                    action: 'optimize_seo'
                });
            }

            // GEO 관련 제안
            if (!analysis.geoCompliance) {
                suggestions.push({
                    type: 'geo',
                    priority: '높음',
                    title: 'GEO 최적화 부족',
                    description: '생성형 AI 엔진 최적화(GEO) 요소가 부족합니다. 구조화된 콘텐츠와 권위 신호를 추가하세요.',
                    action: 'add_geo_context'
                });
            }

            // 정책 균형 관련 제안
            if (!analysis.policyBalanceCompliance) {
                suggestions.push({
                    type: 'balance',
                    priority: '높음',
                    title: '균형 잡힌 관점 부족',
                    description: '균형 잡힌 관점이 부족합니다. 장단점과 고려사항을 추가하세요.',
                    action: 'add_balanced_perspective'
                });
            }

            return suggestions;
        }

        async function improveContentWithAI(originalContent, suggestions) {
            // 개선 제안을 프롬프트로 변환
            const improvementPrompt = createImprovementPrompt(originalContent, suggestions);

            // AbortController를 사용하여 요청 취소 가능하게 만들기
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30초 타임아웃

            try {
                const response = await fetch('/api/v1/improve-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        original_content: originalContent,
                        suggestions: suggestions,
                        improvement_prompt: improvementPrompt
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                return result;

            } catch (error) {
                clearTimeout(timeoutId);

                // AbortError인 경우 사용자에게 알림
                if (error.name === 'AbortError') {
                    console.warn('요청이 타임아웃되었습니다. 로컬 개선을 적용합니다.');
                } else {
                    console.error('AI 개선 요청 실패:', error);
                }

                // AI 개선 실패 시 로컬 개선 적용
                const improvedContent = applyLocalImprovements(originalContent, suggestions);
                return {
                    improved_content: improvedContent,
                    original_analysis: { content_length: 0, length_compliant: false, ai_seo_compliant: false, geo_compliant: false, policy_balance_compliant: false, has_headings: false, has_keywords: false, has_links: false, has_images: false, has_structured_data: false },
                    improved_analysis: { content_length: improvedContent.length, length_compliant: improvedContent.length >= 1500, ai_seo_compliant: false, geo_compliant: false, policy_balance_compliant: false, has_headings: false, has_keywords: false, has_links: false, has_images: false, has_structured_data: false },
                    improvements: [],
                    fallback: true
                };
            }
        }

        function createImprovementPrompt(originalContent, suggestions) {
            let prompt = `다음 콘텐츠를 개선해주세요:\n\n${originalContent}\n\n개선 요청사항:\n`;

            suggestions.forEach((suggestion, index) => {
                prompt += `${index + 1}. ${suggestion.description}\n`;
            });

            prompt += `\n요구사항:\n- 원본 콘텐츠의 핵심 내용은 유지하세요\n- 자연스럽고 읽기 쉽게 개선하세요\n- HTML 태그는 유지하세요\n- 개선된 콘텐츠만 반환하세요`;

            return prompt;
        }

        function applyLocalImprovements(originalContent, suggestions) {
            let improvedContent = originalContent;

            suggestions.forEach(suggestion => {
                switch (suggestion.action) {
                    case 'expand_content':
                        improvedContent = expandContent(improvedContent);
                        break;
                    case 'optimize_seo':
                        improvedContent = optimizeSEO(improvedContent);
                        break;
                    case 'add_geo_context':
                        improvedContent = addGeoContext(improvedContent);
                        break;
                    case 'add_balanced_perspective':
                        improvedContent = addBalancedPerspective(improvedContent);
                        break;
                }
            });

            return improvedContent;
        }

        function expandContent(content) {
            // 콘텐츠 확장 로직
            const expansionTexts = [
                '더 자세한 설명을 위해 추가 정보를 제공하겠습니다.',
                '이러한 변화의 배경과 의미를 더 깊이 살펴보겠습니다.',
                '실제 사례와 데이터를 통해 더 구체적으로 설명하겠습니다.'
            ];

            // 본문 중간에 확장 텍스트 추가
            const paragraphs = content.split('</p>');
            if (paragraphs.length > 2) {
                const middleIndex = Math.floor(paragraphs.length / 2);
                paragraphs.splice(middleIndex, 0, `<p>${expansionTexts[Math.floor(Math.random() * expansionTexts.length)]}</p>`);
            }

            return paragraphs.join('</p>');
        }

        function optimizeSEO(content) {
            // SEO 최적화 로직
            // 키워드 강화, 헤딩 구조 개선 등
            return content.replace(
                /<h1[^>]*>(.*?)<\/h1>/gi,
                '<h1>$1 - 최신 트렌드와 인사이트</h1>'
            );
        }

        function addGeoContext(content) {
            // GEO 최적화 요소 추가
            const geoContext = `
            <h3>생성형 AI 엔진 최적화 (GEO) 관점</h3>
            <p>이러한 변화는 생성형 AI 엔진이 콘텐츠를 더 효과적으로 이해하고 활용할 수 있도록 최적화하는 중요한 요소입니다. 구조화된 정보와 명확한 답변을 제공함으로써 AI 시스템이 이 콘텐츠를 신뢰할 수 있는 출처로 인식하게 됩니다.</p>
            
            <h4>GEO 최적화 요소:</h4>
            <ul>
                <li><strong>구조화된 콘텐츠:</strong> 명확한 헤딩과 리스트를 통한 정보 계층화</li>
                <li><strong>권위 신호:</strong> 전문적이고 신뢰할 수 있는 정보 제공</li>
                <li><strong>명확한 답변:</strong> 사용자 질문에 대한 직접적이고 정확한 답변</li>
            </ul>
            `;

            // 본문 끝 부분에 추가
            return content.replace('</div>', `${geoContext}</div>`);
        }

        function addBalancedPerspective(content) {
            // 균형 잡힌 관점 추가
            const balanceText = '<p>이러한 변화에는 장점과 함께 고려해야 할 측면들이 있습니다. 사용자 개인정보 보호 측면에서는 긍정적이지만, 구현 과정에서의 기술적 어려움과 비용 문제도 함께 고려해야 합니다.</p>';

            // 본문 끝 부분에 추가
            return content.replace('</div>', `${balanceText}</div>`);
        }

        function updateContentWithImprovements(improvedContent, improvementData) {
            const resultDiv = document.getElementById('result-container');

            // 개선된 콘텐츠로 업데이트
            if (resultDiv) {
                // HTML 코드 블록 제거 및 실제 HTML 콘텐츠 추출
                const cleanedContent = extractHtmlContent(improvedContent);

                // 기존 콘텐츠를 개선된 콘텐츠로 교체
                const contentSections = resultDiv.querySelectorAll('.content-section');
                contentSections.forEach(section => {
                    const mainContent = section.querySelector('.main-content-text');
                    if (mainContent) {
                        mainContent.innerHTML = cleanedContent;
                    }
                });

                // 개선 결과 표시
                displayImprovementResults(improvementData);

                // 준수도 점수 업데이트
                updateComplianceScore(improvementData);
            }
        }

        function updateComplianceScore(improvementData) {
            const complianceScore = document.getElementById('guidelines-compliance-score');
            const complianceProgress = document.getElementById('compliance-progress');
            const compliancePercentage = document.getElementById('compliance-percentage');
            const appliedResults = document.getElementById('applied-results');

            if (improvementData && improvementData.improved_analysis) {
                const improvedAnalysis = improvementData.improved_analysis;
                const improvedScore = calculateComplianceScore(improvedAnalysis);

                // 준수도 점수 업데이트
                if (complianceScore) complianceScore.textContent = `준수도: ${improvedScore}%`;
                if (complianceProgress) complianceProgress.style.width = `${improvedScore}%`;
                if (compliancePercentage) compliancePercentage.textContent = `${improvedScore}%`;

                // 적용 결과 업데이트
                if (appliedResults) {
                    const analysisResults = [];

                    // 길이 준수도
                    if (improvedAnalysis.content_length >= 1500) {
                        analysisResults.push(`<div class="result-item result-success">
                            <span class="result-icon">✅</span>
                            <span class="result-text">길이 준수 (${improvedAnalysis.content_length}자)</span>
                        </div>`);
                    } else if (improvedAnalysis.content_length > 0) {
                        analysisResults.push(`<div class="result-item result-warning">
                            <span class="result-icon">⚠️</span>
                            <span class="result-text">길이 부분 준수 (${improvedAnalysis.content_length}자)</span>
                        </div>`);
                    } else {
                        analysisResults.push(`<div class="result-item result-danger">
                            <span class="result-icon">❌</span>
                            <span class="result-text">길이 미준수 (${improvedAnalysis.content_length}자)</span>
                        </div>`);
                    }

                    // AI SEO 준수도
                    if (improvedAnalysis.ai_seo_compliant) {
                        analysisResults.push(`<div class="result-item result-success">
                            <span class="result-icon">✅</span>
                            <span class="result-text">AI SEO 준수</span>
                        </div>`);
                    } else {
                        analysisResults.push(`<div class="result-item result-warning">
                            <span class="result-icon">⚠️</span>
                            <span class="result-text">AI SEO 부분 준수</span>
                        </div>`);
                    }

                    // GEO 준수도
                    if (improvedAnalysis.geo_compliant) {
                        analysisResults.push(`<div class="result-item result-success">
                            <span class="result-icon">✅</span>
                            <span class="result-text">GEO 준수</span>
                        </div>`);
                    } else {
                        analysisResults.push(`<div class="result-item result-warning">
                            <span class="result-icon">⚠️</span>
                            <span class="result-text">GEO 부분 준수</span>
                        </div>`);
                    }

                    // 정책 균형 준수도
                    if (improvedAnalysis.policy_balance_compliant) {
                        analysisResults.push(`<div class="result-item result-success">
                            <span class="result-icon">✅</span>
                            <span class="result-text">정책 균형 준수</span>
                        </div>`);
                    } else {
                        analysisResults.push(`<div class="result-item result-danger">
                            <span class="result-icon">❌</span>
                            <span class="result-text">정책 균형 미준수</span>
                        </div>`);
                    }

                    // 블로그 스타일 준수도
                    if (improvedAnalysis.has_headings && improvedAnalysis.has_keywords) {
                        analysisResults.push(`<div class="result-item result-success">
                            <span class="result-icon">✅</span>
                            <span class="result-text">블로그 스타일 준수</span>
                        </div>`);
                    } else {
                        analysisResults.push(`<div class="result-item result-warning">
                            <span class="result-icon">⚠️</span>
                            <span class="result-text">블로그 스타일 부분 준수</span>
                        </div>`);
                    }

                    appliedResults.innerHTML = analysisResults.join('');
                }

                console.log('준수도 점수 및 적용 결과 업데이트:', improvedScore);
            }
        }

        // 상세 준수도 분석 테이블 행 생성 함수
        function createComplianceDetailRows(original, improved) {
            const items = [
                {
                    name: '콘텐츠 길이',
                    value: improved.content_length || 0,
                    unit: '자',
                    threshold: 1500,
                    description: '1500자 이상 권장'
                },
                {
                    name: 'AI SEO 최적화',
                    value: improved.ai_seo_compliant || false,
                    unit: '',
                    threshold: true,
                    description: '키워드 밀도 및 구조 최적화'
                },
                {
                    name: 'GEO 준수도',
                    value: improved.geo_compliant || false,
                    unit: '',
                    threshold: true,
                    description: '생성형 AI 엔진 최적화'
                },
                {
                    name: '정책 균형',
                    value: improved.policy_balance_compliant || false,
                    unit: '',
                    threshold: true,
                    description: '장단점 균형 있는 서술'
                },
                {
                    name: '구조화',
                    value: improved.has_headings || false,
                    unit: '',
                    threshold: true,
                    description: '헤딩 구조 및 키워드 포함'
                }
            ];

            let html = '';
            items.forEach(item => {
                // 적용 여부 결정 (O/X)
                const isApplied = item.unit ?
                    (item.value >= item.threshold) :
                    (item.value === true);

                // 준수 상태 결정
                const complianceStatus = item.unit ?
                    (item.value >= item.threshold ? 'success' : 'danger') :
                    (item.value ? 'success' : 'danger');

                const appliedText = isApplied ? 'O' : 'X';
                const appliedClass = isApplied ? 'success' : 'danger';

                const complianceText = item.unit ?
                    (item.value >= item.threshold ? '준수' : '미준수') :
                    (item.value ? '준수' : '미준수');

                const complianceIcon = item.unit ?
                    (item.value >= item.threshold ? '✅' : '❌') :
                    (item.value ? '✅' : '❌');

                html +=
                    '<tr>' +
                    '<td>' +
                    '<div class="fw-bold">' + item.name + '</div>' +
                    '<small class="text-muted">' + item.description + '</small>' +
                    '</td>' +
                    '<td class="text-center">' +
                    '<span class="badge bg-' + appliedClass + ' fs-6 fw-bold">' + appliedText + '</span>' +
                    '</td>' +
                    '<td class="text-center">' +
                    '<div class="d-flex align-items-center justify-content-center">' +
                    '<span class="me-2">' + complianceIcon + '</span>' +
                    '<span class="badge bg-' + complianceStatus + '">' + complianceText + '</span>' +
                    '</div>' +
                    '</td>' +
                    '</tr>';
            });

            return html;
        }

        function displayImprovementResults(improvementData) {
            const resultDiv = document.getElementById('result-container');

            // 기존 개선 표시 제거
            const existingImprovement = resultDiv.querySelector('.improvement-results');
            if (existingImprovement) {
                existingImprovement.remove();
            }

            // 개선 결과 컨테이너 생성
            const improvementContainer = document.createElement('div');
            improvementContainer.className = 'improvement-results mt-4';

            // 준수도 점수 변경 표시
            const scoreChangeSection = createScoreChangeSection(improvementData);
            improvementContainer.appendChild(scoreChangeSection);

            // 개선 사항 목록 표시
            const improvementsSection = createImprovementsSection(improvementData);
            improvementContainer.appendChild(improvementsSection);

            // AI 분석 영역 위에 삽입
            const aiAnalysisSection = resultDiv.querySelector('.ai-analysis-section');
            if (aiAnalysisSection) {
                aiAnalysisSection.parentNode.insertBefore(improvementContainer, aiAnalysisSection);
            } else {
                resultDiv.appendChild(improvementContainer);
            }
        }

        function createScoreChangeSection(improvementData) {
            const original = improvementData.original_analysis;
            const improved = improvementData.improved_analysis;
            const originalScore = calculateComplianceScore(original);
            const improvedScore = calculateComplianceScore(improved);
            const scoreChange = improvedScore - originalScore;

            const section = document.createElement('div');
            section.className = 'card mb-3 border-success compliance-improvement-card';
            section.innerHTML = `
                <div class="card-header bg-success text-white">\
                    <h6 class="mb-0">\
                        <i class="bi bi-graph-up me-2"></i>\
                        준수도 점수 개선 결과\
                        <span id="score-change-badge" class="badge bg-light text-muted ms-2">변화 없음</span>\
                    </h6>\
                </div>\
                <div class="card-body">\
                    <!-- 점수 비교 섹션 -->\
                    <div class="row mb-4">\
                        <div class="col-md-3">\
                            <div class="score-display">\
                                <div class="h6 text-muted mb-2">이전 점수</div>\
                                <div id="score-original" class="h2 text-danger fw-bold">0%</div>\
                                <div class="small text-muted">개선 전</div>\
                            </div>\
                        </div>\
                        <div class="col-md-1 d-flex align-items-center justify-content-center">\
                            <div class="text-center">\
                                <i class="bi bi-arrow-right h3 text-success"></i>\
                                <div class="small text-muted mt-1">개선</div>\
                            </div>\
                        </div>\
                        <div class="col-md-3">\
                            <div class="score-display">\
                                <div class="h6 text-muted mb-2">이후 점수</div>\
                                <div id="score-improved" class="h2 text-success fw-bold">0%</div>\
                                <div class="small text-muted">개선 후</div>\
                            </div>\
                        </div>\
                        <div class="col-md-5">\
                            <div class="progress-comparison">\
                                <div class="d-flex justify-content-between mb-2">\
                                    <span class="small text-muted">이전</span>\
                                    <span class="small text-muted">이후</span>\
                                </div>\
                                <div class="progress mb-2" style="height: 12px;">\
                                    <div id="bar-original" class="progress-bar bg-danger"></div>\
                                </div>\
                                <div class="progress" style="height: 12px;">\
                                    <div id="bar-improved" class="progress-bar bg-success"></div>\
                                </div>\
                                <div class="mt-2">\
                                    <small id="score-change-text" class="text-muted"></small>\
                                </div>\
                            </div>\
                        </div>\
                    </div>\
                    \n+                    <!-- 상세 분석 섹션 -->\
                    <div class="row">\
                        <div class="col-12">\
                            <h6 class="text-success mb-3">\
                                <i class="bi bi-bar-chart me-2"></i>상세 준수도 분석\
                            </h6>\
                            <div class="table-responsive">\
                                <table class="table table-sm table-bordered improvement-detail-table">\
                                    <thead class="table-light">\
                                        <tr>\
                                            <th>준수 항목</th>\
                                            <th class="text-center">적용 여부</th>\
                                            <th class="text-center">준수 상태</th>\
                                        </tr>\
                                    </thead>\
                                    <tbody id="compliance-detail-rows">\
                                        <!-- 동적으로 생성됩니다 -->\
                                    </tbody>\
                                </table>\
                            </div>\
                        </div>\
                    </div>\
                </div>`;

            // 동적 값 주입
            const scoreOriginalEl = section.querySelector('#score-original');
            const scoreImprovedEl = section.querySelector('#score-improved');
            const barOriginal = section.querySelector('#bar-original');
            const barImproved = section.querySelector('#bar-improved');
            const changeBadge = section.querySelector('#score-change-badge');
            const changeText = section.querySelector('#score-change-text');

            if (scoreOriginalEl) scoreOriginalEl.textContent = originalScore + '%';
            if (scoreImprovedEl) scoreImprovedEl.textContent = improvedScore + '%';
            if (barOriginal) barOriginal.style.width = originalScore + '%';
            if (barImproved) barImproved.style.width = improvedScore + '%';

            if (changeBadge) {
                if (scoreChange > 0) {
                    changeBadge.className = 'badge bg-light text-success ms-2';
                    changeBadge.textContent = '+' + scoreChange + '%';
                } else if (scoreChange < 0) {
                    changeBadge.className = 'badge bg-light text-danger ms-2';
                    changeBadge.textContent = '' + scoreChange + '%';
                } else {
                    changeBadge.className = 'badge bg-light text-muted ms-2';
                    changeBadge.textContent = '변화 없음';
                }
            }
            if (changeText) {
                changeText.textContent = scoreChange > 0 ? '✅ 개선됨' : scoreChange < 0 ? '⚠️ 감소함' : '➡️ 변화 없음';
            }

            // 상세 준수도 분석 테이블 행 생성
            const complianceDetailRows = section.querySelector('#compliance-detail-rows');
            if (complianceDetailRows) {
                complianceDetailRows.innerHTML = createComplianceDetailRows(original, improved);
            }

            return section;
        }

        function createImprovementsSection(improvementData) {
            const improvements = improvementData.improvements || [];
            const totalImprovements = improvements.length;

            const section = document.createElement('div');
            section.className = 'card border-info';

            const badgeHtml = totalImprovements > 0 ?
                '<span class="badge bg-light text-info ms-2">총 ' + totalImprovements + '개 개선</span>' : '';

            const bodyContent = totalImprovements > 0 ?
                createDetailedImprovementsList(improvements) :
                createNoImprovementsMessage();

            section.innerHTML =
                '<div class="card-header bg-info text-white">' +
                '<h6 class="mb-0">' +
                '<i class="bi bi-list-check me-2"></i>' +
                '개선된 사항 (' + totalImprovements + '개)' +
                badgeHtml +
                '</h6>' +
                '</div>' +
                '<div class="card-body">' +
                bodyContent +
                '</div>';

            return section;
        }

        function createDetailedImprovementsList(improvements) {
            let html = `
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>개선 요약:</strong> 총 ${improvements.length}개 항목이 개선되었습니다.
                        </div>
                    </div>
                </div>
                <div class="row">
            `;

            improvements.forEach((improvement, index) => {
                // 우선순위가 없으면 기본값 설정
                const priority = improvement.priority || '보통';
                const priorityClass = priority === '높음' ? 'border-danger' :
                    priority === '중간' ? 'border-warning' : 'border-info';
                const priorityColor = priority === '높음' ? 'danger' :
                    priority === '중간' ? 'warning' : 'info';

                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card ${priorityClass} h-100 improvement-card">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        ${improvement.category || '개선 사항'}
                                    </h6>
                                    <span class="badge bg-${priorityColor}">${priority}</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <p class="card-text small text-muted mb-2">${improvement.description || '개선이 적용되었습니다.'}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-success">${improvement.improvement || '개선됨'}</span>
                                    <small class="text-muted">#${index + 1}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-success">
                            <i class="bi bi-lightbulb me-2"></i>
                            <strong>팁:</strong> 개선된 콘텐츠는 더 나은 SEO 성과와 사용자 경험을 제공합니다.
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        function createNoImprovementsMessage() {
            return `
                <div class="text-center py-4">
                    <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-muted">개선된 사항이 없습니다</h5>
                    <p class="text-muted">현재 콘텐츠가 이미 최적화되어 있어 추가 개선이 필요하지 않습니다.</p>
                    <div class="alert alert-light">
                        <i class="bi bi-info-circle me-2"></i>
                        콘텐츠가 이미 높은 품질을 유지하고 있습니다.
                    </div>
                </div>
            `;
        }

        function showHelpModal() {
            const helpContent = `
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-lightbulb me-2"></i>문제 해결 가이드
                        </h6>
                        <div class="accordion" id="helpAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#help1">
                                        API 키 오류가 발생합니다
                                    </button>
                                </h2>
                                <div id="help1" class="accordion-collapse collapse show" data-bs-parent="#helpAccordion">
                                    <div class="accordion-body">
                                        <p>API 키가 설정되지 않았거나 유효하지 않습니다.</p>
                                        <ul>
                                            <li>관리자에게 API 키 설정을 요청하세요</li>
                                            <li>환경 변수 파일(.env)을 확인하세요</li>
                                            <li>API 키가 올바르게 입력되었는지 확인하세요</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help2">
                                        번역 서비스 오류가 발생합니다
                                    </button>
                                </h2>
                                <div id="help2" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                    <div class="accordion-body">
                                        <p>번역 서비스에 일시적인 문제가 있을 수 있습니다.</p>
                                        <ul>
                                            <li>잠시 후 다시 시도해주세요</li>
                                            <li>네트워크 연결을 확인하세요</li>
                                            <li>다른 URL이나 텍스트로 시도해보세요</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help3">
                                        콘텐츠가 너무 짧습니다
                                    </button>
                                </h2>
                                <div id="help3" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                    <div class="accordion-body">
                                        <p>생성된 콘텐츠가 최소 길이 요구사항을 충족하지 못했습니다.</p>
                                        <ul>
                                            <li>더 긴 텍스트를 입력해주세요</li>
                                            <li>다른 URL을 시도해보세요</li>
                                            <li>콘텐츠 길이 설정을 조정해보세요</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 도움말 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('analysisHelpModal'));
            document.getElementById('analysisHelpModalLabel').innerHTML = '<i class="bi bi-question-circle me-2"></i>문제 해결 도움말';
            document.getElementById('analysis-help-content').innerHTML = helpContent;
            modal.show();
        }

        function createImprovementsList(improvements) {
            let html = '<ul class="list-group list-group-flush">';

            improvements.forEach((improvement, index) => {
                html +=
                    '<li class="list-group-item d-flex justify-content-between align-items-start">' +
                    '<div class="ms-2 me-auto">' +
                    '<div class="fw-bold text-primary">' + improvement.category + '</div>' +
                    '<div class="text-muted small">' + improvement.description + '</div>' +
                    '</div>' +
                    '<span class="badge bg-success rounded-pill">' + improvement.improvement + '</span>' +
                    '</li>';
            });

            html += '</ul>';
            return html;
        }

        function calculateComplianceScore(analysis) {
            let score = 0;
            let total = 5; // 총 5개 항목

            if (analysis.length_compliant) score++;
            if (analysis.ai_seo_compliant) score++;
            if (analysis.geo_compliant) score++;
            if (analysis.policy_balance_compliant) score++;
            if (analysis.has_headings) score++;

            return Math.round((score / total) * 100);
        }

        function calculateComplianceRate(analysis) {
            let score = 0;
            let total = 5; // 총 5개 항목

            // 콘텐츠 길이 준수 (1500자 이상)
            if (analysis.contentLength >= 1500) score++;

            // AI SEO 준수
            if (analysis.aiSeoCompliance) score++;

            // GEO 준수
            if (analysis.geoCompliance) score++;

            // 정책 균형 준수
            if (analysis.policyBalanceCompliance) score++;

            // 블로그 스타일 준수 (헤딩과 키워드)
            if (analysis.hasHeadings && analysis.hasKeywords) score++;

            return Math.round((score / total) * 100);
        }

        // Enter 키로 생성 시작
        document.getElementById('text_input').addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                generateContent();
            }
        });
    </script>
</body>

</html>