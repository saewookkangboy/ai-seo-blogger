<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리 대시보드 - AI Blog Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/common.css">
    <style>
        body, html { font-family: 'IBM Plex Sans KR', sans-serif !important; }
        body { background-color: #f8f9fa; }
        .container { max-width: 960px; }
        .card { margin-bottom: 1.5rem; }
        #result-container {
            border: 1px solid #dee2e6;
            border-radius: .375rem;
            padding: 1.5rem;
            background-color: #fff;
            min-height: 200px;
            max-height: 600px;
            overflow-y: auto;
        }
        .keyword-badge {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .progress-container {
            display: none;
            margin: 1rem 0;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            background-color: #e9ecef;
            border-radius: 0.375rem;
            margin: 0 0.25rem;
        }
        .step.active {
            background-color: #007bff;
            color: white;
        }
        .step.completed {
            background-color: #28a745;
            color: white;
        }
        .table-keywords th, .table-keywords td {
            font-size: 0.97rem;
            padding: 0.45rem 0.5rem;
            vertical-align: middle;
            text-align: center;
        }
        .table-keywords th {
            background: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        .table-keywords tbody tr:hover {
            background: #f1f3f5;
        }
        .table-keywords td.text-end {
            text-align: right;
        }
        .table-keywords td.text-success {
            font-weight: 600;
            letter-spacing: 0.01em;
        }
        .table-keywords td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .table-keywords th.col-multiline, .table-keywords td.col-multiline {
            min-width: 80px;
            max-width: 80px;
            white-space: normal;
            word-break: keep-all;
            line-height: 1.2;
            padding-top: 0.3rem;
            padding-bottom: 0.3rem;
        }
        .table-keywords th.col-visual, .table-keywords td.col-visual {
            min-width: 120px;
            width: 160px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-cloud/build/d3.layout.cloud.js"></script>
</head>
<body>
    {% include '_navbar.html' %}
    <div class="container" style="padding-top: 84px; padding-bottom: 120px;">
        <h1 class="mb-4"><i class="bi bi-gear"></i> 관리 대시보드</h1>
        <ul class="nav nav-tabs mb-4" id="adminTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-stats" data-bs-toggle="tab" data-bs-target="#stats-panel" type="button" role="tab">일자별 통계</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-keywords" data-bs-toggle="tab" data-bs-target="#keywords-panel" type="button" role="tab">키워드 관리</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-crawl" data-bs-toggle="tab" data-bs-target="#crawl-panel" type="button" role="tab">크롤링 관리</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-system" data-bs-toggle="tab" data-bs-target="#system-panel" type="button" role="tab">시스템 관리</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-feature-updates-history" data-bs-toggle="tab" data-bs-target="#feature-updates-history-panel" type="button" role="tab">기능 업데이트 이력</button>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade show active" id="stats-panel" role="tabpanel">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-bar-chart"></i> 일자별 통계
                    </div>
                    <div class="card-body">
                        <div class="mb-3 d-flex flex-wrap align-items-center gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="loadStats(7)">7일</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="loadStats(14)">14일</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="loadStats(30)">30일</button>
                            <span class="ms-2">사용자 설정:</span>
                            <input type="date" id="statsStart" class="form-control form-control-sm" style="width:auto;display:inline-block;">
                            <span>~</span>
                            <input type="date" id="statsEnd" class="form-control form-control-sm" style="width:auto;display:inline-block;">
                            <button class="btn btn-outline-success btn-sm" onclick="loadStats('custom')">조회</button>
                        </div>
                        <canvas id="statsChart" height="80"></canvas>
                        <div class="mt-2" style="font-weight:500;color:#e53935;font-family:'IBM Plex Sans KR','Apple SD Gothic Neo','Malgun Gothic','맑은 고딕','Nanum Gothic','나눔고딕',sans-serif;">최근 7일 기준의 데이터</div>
                        <!-- 오늘의 기능 업데이트 알림 (미니멀/플랫) -->
                        <div id="today-feature-update" class="alert alert-info d-flex align-items-center mt-3 mb-0 py-2 border-0 shadow-none" style="font-size:0.97em;background:#eaf4fb;font-weight:bold;">
                            <i class="bi bi-lightbulb me-2"></i>
                            <span id="today-feature-update-text"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="keywords-panel" role="tabpanel">
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <i class="bi bi-tags"></i> 키워드 관리
                    </div>
                    <div class="card-body">
                        <!-- AI/자동화 카드 -->
                        <div class="row mb-3" id="keyword-ai-cards">
                            <div class="col-12 col-md-4 mb-2">
                                <div class="card border-primary h-100">
                                    <div class="card-body py-2">
                                        <div class="fw-bold text-primary mb-1"><i class="bi bi-stars"></i> 추천 키워드</div>
                                        <div class="small text-muted mb-1">최근 포스트 기반, 등장 빈도+AI 추천 혼합</div>
                                        <div id="ai-recommend-keywords" class="small">-</div>
                                        <button class="btn btn-outline-primary btn-sm mt-2" onclick="showRecommendModal()">상세보기</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-4 mb-2">
                                <div class="card border-danger h-100">
                                    <div class="card-body py-2">
                                        <div class="fw-bold text-danger mb-1"><i class="bi bi-link"></i> 유사/중복 키워드</div>
                                        <div class="small text-muted mb-1">문자열 유사도(Levenshtein) 기준</div>
                                        <div class="d-flex align-items-center gap-2 mb-1">
                                            <label for="simThreshold" class="form-label mb-0 small">유사도 기준:</label>
                                            <select id="simThreshold" class="form-select form-select-sm w-auto" onchange="renderAIKeywordFeatures([])">
                                                <option value="0.7">0.7</option>
                                                <option value="0.8" selected>0.8</option>
                                                <option value="0.9">0.9</option>
                                            </select>
                                        </div>
                                        <div id="ai-dup-keywords" class="small">-</div>
                                        <button class="btn btn-outline-danger btn-sm mt-2" onclick="showDupModal()">병합 제안</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-4 mb-2">
                                <div class="card border-success h-100">
                                    <div class="card-body py-2">
                                        <div class="fw-bold text-success mb-1"><i class="bi bi-translate"></i> 번역/동의어 관리</div>
                                        <div class="small text-muted mb-1">수동/자동 동의어 관리, 다국어 지원</div>
                                        <div id="ai-syn-keywords" class="small">-</div>
                                        <button class="btn btn-outline-success btn-sm mt-2" onclick="showSynModal()">관리</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 요약 카드 -->
                        <div class="row mb-3" id="keyword-summary-cards">
                            <div class="col-6 col-md-2 mb-2"><div class="card text-center"><div class="card-body py-2"><div class="fw-bold" id="sum-total">-</div><div class="small text-muted">전체</div></div></div></div>
                            <div class="col-6 col-md-2 mb-2"><div class="card text-center"><div class="card-body py-2"><div class="fw-bold text-danger" id="sum-black">-</div><div class="small text-muted">블랙리스트</div></div></div></div>
                            <div class="col-6 col-md-2 mb-2"><div class="card text-center"><div class="card-body py-2"><div class="fw-bold text-success" id="sum-white">-</div><div class="small text-muted">화이트리스트</div></div></div></div>
                            <div class="col-6 col-md-2 mb-2"><div class="card text-center"><div class="card-body py-2"><div class="fw-bold text-primary" id="sum-new">-</div><div class="small text-muted">신규</div></div></div></div>
                            <div class="col-6 col-md-2 mb-2"><div class="card text-center"><div class="card-body py-2"><div class="fw-bold text-secondary" id="sum-deleted">-</div><div class="small text-muted">삭제</div></div></div></div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div id="keyword-wordcloud" style="height:220px;background:#fff;border:1px solid #eee;"></div>
                            </div>
                            <div class="col-md-6">
                                <canvas id="keyword-trend-chart" height="180"></canvas>
                            </div>
                        </div>
                        <div class="mb-3 d-flex align-items-center gap-2">
                            <input type="text" id="keywordSearchInput" class="form-control form-control-sm" style="max-width:220px;" placeholder="키워드 검색/필터" oninput="filterKeywordsTable()">
                            <span class="text-muted small">키워드, 고유 개수 등으로 실시간 필터</span>
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-outline-dark btn-sm me-2" onclick="showKeywordListModal('black')"><i class="bi bi-x-circle"></i> 블랙리스트 관리</button>
                            <button class="btn btn-outline-success btn-sm" onclick="showKeywordListModal('white')"><i class="bi bi-check-circle"></i> 화이트리스트 관리</button>
                        </div>
                        <div id="keywords-table-container">
                            <div class="text-muted">불러오는 중...</div>
                        </div>
                    </div>
                </div>
                <!-- 블랙/화이트리스트 관리 모달 -->
                <div class="modal fade" id="keywordListModal" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="keywordListModalTitle">키워드 리스트 관리</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <form id="keywordListForm">
                          <input type="hidden" id="keywordListType">
                          <div class="mb-2">
                            <label for="keywordListInput" class="form-label">키워드 (쉼표 또는 줄바꿈 구분)</label>
                            <textarea id="keywordListInput" class="form-control" rows="5"></textarea>
                          </div>
                        </form>
                        <div id="keywordListTableContainer" class="mt-3"></div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="button" class="btn btn-primary" onclick="submitKeywordListForm()">저장</button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- 추천/유사/동의어 모달 -->
                <div class="modal fade" id="recommendModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">추천 키워드 상세</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="recommendModalBody"><div class='mb-2 text-muted small'>추천 방식: 최근 포스트+등장 빈도+AI 추천 혼합(향후 GPT/Embedding 연동 가능)</div></div></div></div></div>
                <div class="modal fade" id="dupModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">유사/중복 키워드 병합</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="dupModalBody"><div class='mb-2 text-muted small'>유사도 기준: Levenshtein, 선택값 이상(0~1, 높을수록 엄격)</div></div></div></div></div>
                <div class="modal fade" id="synModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">번역/동의어 관리</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="synModalBody"><div class='mb-2 text-muted small'>동의어/번역어는 수동 추가/삭제, 향후 AI 자동 추천/번역 연동 가능</div></div></div></div></div>
            </div>
            <div class="tab-pane fade" id="crawl-panel" role="tabpanel">
                <ul class="nav nav-tabs mb-3" id="crawlSubTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="crawl-manage-tab" data-bs-toggle="tab" data-bs-target="#crawl-manage-panel" type="button" role="tab">크롤링 관리</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="crawl-status-tab" data-bs-toggle="tab" data-bs-target="#crawl-status-panel" type="button" role="tab">크롤링 현황판</button>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="crawl-manage-panel" role="tabpanel">
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <i class="bi bi-bug"></i> 크롤링 관리
                            </div>
                            <div class="card-body">
                                <ul>
                                    <li>크롤링 실패 내역 확인 및 재시도</li>
                                    <li>사이트별 크롤링 설정 관리</li>
                                    <li>크롤링 로그 다운로드</li>
                                </ul>
                                <div class="mt-4">
                                    <h5>최근 크롤링 실패 내역</h5>
                                    <div id="failures-table-container">
                                        <div class="text-muted">불러오는 중...</div>
                                    </div>
                                </div>
                                <hr class="my-4">
                                <div class="mt-4">
                                    <h5>사이트별 크롤링 설정 관리</h5>
                                    <div id="site-configs-container">
                                        <div class="text-muted">불러오는 중...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="crawl-status-panel" role="tabpanel">
                        <div class="card mb-4">
                            <div class="card-header bg-secondary text-white">
                                <i class="bi bi-activity"></i> 크롤링 현황판
                            </div>
                            <div class="card-body">
                                <div id="crawl-overall-container" class="mb-3"></div>
                                <div id="crawl-problem-sites-container" class="mb-3"></div>
                                <div id="crawl-recent-attempts-container" class="mb-3"></div>
                                <div id="crawl-report-container" class="mb-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="system-panel" role="tabpanel">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-hdd-network"></i> 시스템 관리
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h5>DB 백업</h5>
                            <a href="/api/v1/system/db-backup" class="btn btn-outline-primary btn-sm" download>
                                <i class="bi bi-download"></i> DB 파일 다운로드
                            </a>
                        </div>
                        <div class="mb-4">
                            <h5>로그 파일 다운로드</h5>
                            <div id="log-list-container">
                                <div class="text-muted">불러오는 중...</div>
                            </div>
                        </div>
                        <div class="alert alert-secondary">환경설정 등 추가 시스템 관리 기능은 추후 지원 예정입니다.</div>
                        <!-- API Key 관리 카드 -->
                        <div class="card mt-4">
                            <div class="card-header bg-dark text-white" style="cursor:pointer;" data-bs-toggle="collapse" data-bs-target="#collapseApiKey" aria-expanded="false" aria-controls="collapseApiKey">
                                <i class="bi bi-key"></i> API Key 관리 <span class="float-end"><i class="bi bi-chevron-down"></i></span>
                            </div>
                            <div id="collapseApiKey" class="collapse">
                            <div class="card-body">
                                <div class="mb-3 text-muted">OpenAI, DeepL, Gemini 등 API Key를 안전하게 관리하세요. (일부만 노출, 활성/비활성, 수정/삭제 가능)</div>
                                <div class="mb-3 text-end">
                                    <button class="btn btn-primary btn-sm" onclick="showApiKeyModal()"><i class="bi bi-plus"></i> 새 API Key 등록</button>
                                </div>
                                <div id="api-keys-table-container"><div class="text-muted">불러오는 중...</div></div>
                            </div>
                            </div>
                        </div>
                        <!-- 포스트 관리 카드 (시스템 관리 내, collapse) -->
                        <div class="card mt-4">
                            <div class="card-header bg-info text-dark" style="cursor:pointer;" data-bs-toggle="collapse" data-bs-target="#collapsePostsBulk" aria-expanded="false" aria-controls="collapsePostsBulk">
                                <i class="bi bi-journal-text"></i> 포스트 일괄 관리 <span class="float-end"><i class="bi bi-chevron-down"></i></span>
                            </div>
                            <div id="collapsePostsBulk" class="collapse">
                                <div class="card-body">
                                    <div class="mb-3 d-flex flex-wrap gap-2">
                                        <button class="btn btn-danger btn-sm" onclick="bulkDeletePosts()"><i class="bi bi-trash"></i> 선택 삭제</button>
                                        <button class="btn btn-outline-primary btn-sm" onclick="exportPosts()"><i class="bi bi-download"></i> 백업(내보내기)</button>
                                        <button class="btn btn-outline-success btn-sm" onclick="showImportModal()"><i class="bi bi-upload"></i> 복원(가져오기)</button>
                                        <button class="btn btn-outline-success btn-sm" onclick="exportPostsXlsx()"><i class="bi bi-file-earmark-excel"></i> 엑셀로 내보내기</button>
                                    </div>
                                    <div id="posts-bulk-table-container">
                                        <div class="text-muted">불러오는 중...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 포스트 복원(가져오기) 모달 -->
                        <div class="modal fade" id="importModal" tabindex="-1">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title">포스트 복원(가져오기)</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                              </div>
                              <div class="modal-body">
                                <input type="file" id="importFileInput" class="form-control">
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                <button type="button" class="btn btn-primary" onclick="importPosts()">가져오기</button>
                              </div>
                            </div>
                          </div>
                        </div>
                        <!-- AI RULE/가이드라인 적용 카드 (이동) -->
                        <div class="card mb-4">
                            <div class="card-header bg-secondary text-white">
                                <i class="bi bi-sliders"></i> AI RULE/가이드라인 적용
                            </div>
                            <div class="card-body">
                                <form id="ai-rule-form" method="post" action="/admin/apply_rules">
                                    <div class="mb-2 d-flex align-items-center flex-wrap gap-3">
                                        <label class="form-check-label mb-0">
                                            <input class="form-check-input me-1" type="checkbox" name="rules" value="AI_SEO"> AI SEO
                                        </label>
                                        <label class="form-check-label mb-0">
                                            <input class="form-check-input me-1" type="checkbox" name="rules" value="AI_SEARCH"> AI SEARCH
                                        </label>
                                        <label class="form-check-label mb-0">
                                            <input class="form-check-input me-1" type="checkbox" name="rules" value="AIEO"> AIEO
                                        </label>
                                        <label for="ai_mode" class="form-label mb-0 ms-2 me-2">AI MODE:</label>
                                        <select class="form-select d-inline-block w-auto me-2" name="ai_mode" id="ai_mode">
                                            <option value="">선택 안함</option>
                                            <option value="뉴스">뉴스</option>
                                            <option value="리뷰">리뷰</option>
                                            <option value="가이드">가이드</option>
                                            <option value="요약">요약</option>
                                            <option value="블로그">블로그</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary btn-sm">적용</button>
                                </form>
                            </div>
                        </div>
                        <div class="mb-4">
                            <h5>기능 업데이트 이력(히스토리)</h5>
                            <div class="alert alert-info mb-0">
                                <i class="bi bi-info-circle"></i> 상단 탭의 <b>기능 업데이트 이력</b>에서 전체 이력을 확인하세요.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="feature-updates-history-panel" role="tabpanel">
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <i class="bi bi-clock-history"></i> 기능 업데이트 이력(히스토리)
                    </div>
                    <div class="card-body">
                        <div id="feature-updates-history-list" class="mb-3">불러오는 중...</div>
                        <div class="text-center">
                            <button class="btn btn-outline-primary btn-sm" onclick="loadFeatureUpdatesHistory()"><i class="bi bi-arrow-clockwise"></i> 새로고침</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- floating 이전 화면으로 버튼 -->
    <a href="/" class="btn btn-outline-secondary position-fixed" id="backToPrevBtn" style="right:32px;bottom:32px;z-index:1050;box-shadow:0 2px 8px rgba(0,0,0,0.12);">
        <i class="bi bi-arrow-left"></i> 이전 화면으로
    </a>

    <!-- 고정형 copyright footer -->
    <footer class="footer position-fixed w-100 text-center bg-dark text-white py-2" style="left:0;bottom:0;z-index:1050;box-shadow:0 -2px 8px rgba(0,0,0,0.08);font-size:0.97rem;letter-spacing:0.01em;">
        <span style="opacity:0.85;">
            &copy; made by <strong>chunghyo</strong>, 2026 &nbsp;|&nbsp; email : <a href="mailto:chunghyo@troe.kr" class="text-warning text-decoration-none">chunghyo@troe.kr</a>
        </span>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    let statsChartInstance = null;

    function loadStats(period) {
        let url = '/api/v1/stats/daily';
        let apiUrl = '/api/v1/stats/api-usage-daily';
        if (period === 7 || period === 14 || period === 30) {
            url += `?days=${period}`;
            apiUrl += `?days=${period}`;
        } else if (period === 'custom') {
            const start = document.getElementById('statsStart').value;
            const end = document.getElementById('statsEnd').value;
            if (!start || !end) {
                alert('시작일과 종료일을 모두 선택하세요.');
                return;
            }
            url += `?start=${start}&end=${end}`;
            apiUrl += `&start=${start}&end=${end}`;
        }
        Promise.all([
            fetch(url).then(res => res.json()),
            fetch(apiUrl).then(res => res.json())
        ]).then(([data, apiUsage]) => {
            renderStatsChart(data, apiUsage);
        });
    }

    function renderStatsChart(data, apiUsage) {
        const ctx = document.getElementById('statsChart').getContext('2d');
        if (statsChartInstance) {
            statsChartInstance.destroy();
        }
        statsChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.dates,
                datasets: [
                    {
                        label: '크롤링 시도',
                        data: data.crawling,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        yAxisID: 'y',
                        type: 'bar',
                    },
                    {
                        label: '원고 초안 작성',
                        data: data.posts,
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                        yAxisID: 'y',
                        type: 'bar',
                    },
                    {
                        label: 'OpenAI 호출',
                        data: apiUsage && apiUsage.openai ? apiUsage.openai : [],
                        borderColor: 'rgba(0, 123, 255, 1)',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        pointRadius: 2,
                        fill: false,
                        yAxisID: 'y2',
                        type: 'line',
                        tension: 0.2
                    },
                    {
                        label: 'DeepL 호출',
                        data: apiUsage && apiUsage.deepl ? apiUsage.deepl : [],
                        borderColor: 'rgba(40, 167, 69, 1)',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 2,
                        pointRadius: 2,
                        fill: false,
                        yAxisID: 'y2',
                        type: 'line',
                        tension: 0.2
                    },
                    {
                        label: 'Gemini 호출',
                        data: apiUsage && apiUsage.gemini ? apiUsage.gemini : [],
                        borderColor: 'rgba(255, 193, 7, 1)',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        borderWidth: 2,
                        pointRadius: 2,
                        fill: false,
                        yAxisID: 'y2',
                        type: 'line',
                        tension: 0.2
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: '일자별 통계 (API 호출 포함)' }
                },
                scales: {
                    x: { title: { display: true, text: '날짜' } },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: '건수(크롤링/원고)' },
                        position: 'left',
                        grid: { drawOnChartArea: true }
                    },
                    y2: {
                        beginAtZero: true,
                        title: { display: true, text: 'API 호출 수' },
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        ticks: { color: '#007bff' }
                    }
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadStats(7); // 페이지 로드시 무조건 7일 그래프 표시
        loadFailures();
        loadSiteConfigs();
        loadLogList();
        loadKeywordsStats();
        // 크롤링 현황판 로드
        loadCrawlingDashboard();
        // 탭 전환 시 통계 그래프 로드 (중복 방지)
        document.getElementById('tab-stats').addEventListener('shown.bs.tab', function() {
            if (!window._statsChartLoaded) {
                loadStats(7);
                window._statsChartLoaded = true;
            }
        });
        document.getElementById('tab-crawl').addEventListener('shown.bs.tab', function() {
            loadCrawlingDashboard();
        });
        document.getElementById('tab-system').addEventListener('shown.bs.tab', function() {
            loadLogList();
            loadApiKeys();
        });
        document.getElementById('tab-keywords').addEventListener('shown.bs.tab', function() {
            loadKeywordsStats();
        });
        loadApiKeys();
    });

    function loadFailures() {
        fetch('/api/v1/crawling/failures')
            .then(res => res.json())
            .then(data => {
                renderFailuresTable(data);
            })
            .catch(err => {
                document.getElementById('failures-table-container').innerHTML = '<div class="text-danger">실패 내역을 불러올 수 없습니다.</div>';
            });
    }

    function renderFailuresTable(failures) {
        const container = document.getElementById('failures-table-container');
        if (!failures || failures.length === 0) {
            container.innerHTML = '<div class="alert alert-success">최근 크롤링 실패 내역이 없습니다.</div>';
            return;
        }
        let html = `<div class="table-responsive"><table class="table table-bordered table-sm align-middle">
            <thead class="table-light">
                <tr>
                    <th>시도 시각</th>
                    <th>도메인</th>
                    <th>URL</th>
                    <th>실패 사유</th>
                    <th>재시도</th>
                </tr>
            </thead>
            <tbody>`;
        for (const f of failures) {
            html += `<tr>
                <td>${f.timestamp ? f.timestamp.replace('T', ' ').slice(0, 19) : ''}</td>
                <td>${f.domain || ''}</td>
                <td style="max-width:320px;word-break:break-all"><a href="${f.url}" target="_blank">${f.url}</a></td>
                <td>${f.error || ''}</td>
                <td><button class="btn btn-outline-primary btn-sm" onclick="retryCrawling(this, '${encodeURIComponent(f.url)}')">재시도</button></td>
            </tr>`;
        }
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function retryCrawling(btn, urlEnc) {
        const url = decodeURIComponent(urlEnc);
        btn.disabled = true;
        btn.textContent = '시도 중...';
        fetch('/api/v1/crawling/retry', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('크롤링 성공!');
                loadFailures(); // 성공 시 테이블 새로고침
            } else {
                alert('실패: ' + (data.message || '크롤링 실패'));
                btn.disabled = false;
                btn.textContent = '재시도';
            }
        })
        .catch(err => {
            alert('오류: ' + err);
            btn.disabled = false;
            btn.textContent = '재시도';
        });
    }

    // 사이트별 크롤링 설정 관리

    function loadSiteConfigs() {
        fetch('/api/v1/crawling/sites')
            .then(res => res.json())
            .then(data => renderSiteConfigs(data))
            .catch(err => {
                document.getElementById('site-configs-container').innerHTML = '<div class="text-danger">설정 정보를 불러올 수 없습니다.</div>';
            });
    }

    function renderSiteConfigs(configs) {
        const container = document.getElementById('site-configs-container');
        if (!configs || Object.keys(configs).length === 0) {
            container.innerHTML = '<div class="alert alert-warning">등록된 사이트별 설정이 없습니다.</div>';
            return;
        }
        let html = `<div class="table-responsive"><table class="table table-bordered table-sm align-middle">
            <thead class="table-light">
                <tr>
                    <th>도메인</th>
                    <th>본문 선택자(selectors)</th>
                    <th>제외 선택자(exclude)</th>
                    <th>텍스트 필터</th>
                    <th>저장</th>
                </tr>
            </thead>
            <tbody>`;
        for (const domain in configs) {
            const c = configs[domain];
            html += `<tr>
                <td><strong>${domain}</strong></td>
                <td><textarea class="form-control form-control-sm" rows="4" id="selectors_${domain}">${(c.selectors||[]).join('\n')}</textarea></td>
                <td><textarea class="form-control form-control-sm" rows="4" id="exclude_${domain}">${(c.exclude_selectors||[]).join('\n')}</textarea></td>
                <td><textarea class="form-control form-control-sm" rows="4" id="filters_${domain}">${(c.text_filters||[]).join('\n')}</textarea></td>
                <td><button class="btn btn-success btn-sm" onclick="saveSiteConfig('${domain}')">저장</button></td>
            </tr>`;
        }
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function saveSiteConfig(domain) {
        const selectors = document.getElementById('selectors_' + domain).value.split('\n').map(s => s.trim()).filter(Boolean);
        const exclude_selectors = document.getElementById('exclude_' + domain).value.split('\n').map(s => s.trim()).filter(Boolean);
        const text_filters = document.getElementById('filters_' + domain).value.split('\n').map(s => s.trim()).filter(Boolean);
        fetch('/api/v1/crawling/sites/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ domain, selectors, exclude_selectors, text_filters })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('저장되었습니다!');
                loadSiteConfigs();
            } else {
                alert('저장 실패: ' + (data.message || '오류'));
            }
        })
        .catch(err => {
            alert('저장 중 오류: ' + err);
        });
    }

    function loadLogList() {
        fetch('/api/v1/system/logs')
            .then(res => res.json())
            .then(files => {
                const container = document.getElementById('log-list-container');
                if (!files || files.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">로그 파일이 없습니다.</div>';
                    return;
                }
                let html = '<ul class="list-group">';
                for (const f of files) {
                    html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${f}</span>
                        <a href="/api/v1/system/logs/download?filename=${encodeURIComponent(f)}" class="btn btn-outline-secondary btn-sm" download><i class="bi bi-download"></i> 다운로드</a>
                    </li>`;
                }
                html += '</ul>';
                container.innerHTML = html;
            })
            .catch(() => {
                document.getElementById('log-list-container').innerHTML = '<div class="text-danger">로그 파일 목록을 불러올 수 없습니다.</div>';
            });
    }

    function loadKeywordsStats() {
        fetch('/api/v1/keywords/stats')
            .then(res => res.json())
            .then(data => renderKeywordsTable(data));
    }

    function renderKeywordsTable(stats) {
        renderAIKeywordFeatures(stats);
        renderKeywordSummary(stats);
        const container = document.getElementById('keywords-table-container');
        if (!stats || stats.length === 0) {
            container.innerHTML = '<div class="alert alert-info">키워드가 없습니다.</div>';
            renderKeywordWordcloud([]); renderKeywordTrendChart([],[]);
            return;
        }
        // 워드클라우드 데이터(상위 30개)
        const wordcloudData = stats.slice(0,30).map(s => ({ text: s.keyword, size: 16 + Math.round(s.count*1.5) }));
        renderKeywordWordcloud(wordcloudData);
        // 트렌드 차트 데이터(샘플: 최근 7일, 실제는 API 필요)
        const labels = Array.from({length:7}, (_,i)=>`D-${6-i}`);
        const counts = stats.slice(0,7).map(s=>s.count);
        renderKeywordTrendChart(labels, counts);
        // 페이지네이션 적용 (30개씩)
        let currentPage = 1;
        let pageSize = 30;
        let totalPages = Math.ceil(stats.length / pageSize);
        function renderPage(page) {
            currentPage = page;
            const startIdx = (page-1)*pageSize;
            const endIdx = startIdx+pageSize;
            const pagedStats = stats.slice(startIdx, endIdx);
            const maxCount = Math.max(...stats.map(s => s.count));
            let html = `<div class="table-responsive"><table class="table table-bordered table-sm align-middle table-keywords">
                <thead class="table-light">
                    <tr>
                        <th>번호</th>
                        <th>키워드</th>
                        <th class="col-multiline"><div>고유 개수</div></th>
                        <th class="col-multiline"><div>네이버 월간<br>검색량</div></th>
                        <th class="col-multiline"><div>네이버<br>순위</div></th>
                        <th class="col-visual">시각화</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody>`;
            pagedStats.forEach((s, idx) => {
                const barWidth = maxCount ? Math.round((s.count / maxCount) * 100) : 0;
                html += `<tr class="fadein-row">
                    <td class="text-center">${startIdx + idx + 1}</td>
                    <td>${s.keyword}</td>
                    <td class="col-multiline"><div>${s.count}</div></td>
                    <td class="col-multiline"><div class="fw-bold text-success">${s.naver_volume ?? '-'}</div></td>
                    <td class="col-multiline"><div class="fw-bold text-success">${s.naver_rank ?? '-'}</div></td>
                    <td class="col-visual"><div style="background:#ffc107;height:18px;width:${barWidth}%;min-width:2px;"></div></td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm me-1" onclick="searchPostsByKeyword('${s.keyword}')"><i class="bi bi-search"></i> 포스트 검색</button>
                        <button class="btn btn-outline-dark btn-sm me-1" onclick="moveKeywordType('${s.keyword}','black')">블랙</button>
                        <button class="btn btn-outline-success btn-sm" onclick="moveKeywordType('${s.keyword}','white')">화이트</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            // 페이지네이션 렌더링 (생성 기록과 동일한 스타일)
            if (totalPages > 1) {
                html += '<nav><ul class="pagination justify-content-center mt-2">';
                for (let i = 1; i <= totalPages; i++) {
                    html += `<li class="page-item${i === currentPage ? ' active' : ''}"><a class="page-link" href="#" onclick="event.preventDefault(); renderPage(${i});">${i}</a></li>`;
                }
                html += '</ul></nav>';
            }
            container.innerHTML = html;
            // fade-in 애니메이션
            document.querySelectorAll('.fadein-row').forEach(row => {
                row.style.opacity = 0;
                setTimeout(()=>{ row.style.transition='opacity 0.7s'; row.style.opacity=1; }, 30);
            });
        }
        // 전역에서 접근 가능하도록 window에 등록
        window.renderPage = renderPage;
        renderPage(1);
    }

    function searchPostsByKeyword(keyword) {
        // 생성 기록 페이지로 이동, 쿼리 파라미터로 전달
        window.location.href = '/history?keyword=' + encodeURIComponent(keyword);
    }

    function moveKeywordType(keyword, type) {
        alert('['+keyword+']를 '+(type==='black'?'블랙리스트':'화이트리스트')+'로 이동 기능은 추후 구현됩니다.');
    }

    // 크롤링 현황판 함수
    function loadCrawlingDashboard() {
        // 전체 통계
        fetch('/api/v1/admin/crawling/overall')
            .then(res => res.json())
            .then(data => {
                let html = `<div><strong>전체 시도:</strong> ${data.total_attempts ?? '-'}회, <strong>성공:</strong> ${data.successful_crawls ?? '-'}회, <strong>실패:</strong> ${data.failed_crawls ?? '-'}회, <strong>성공률:</strong> ${(data.success_rate*100).toFixed(1) ?? '-'}%</div>`;
                document.getElementById('crawl-overall-container').innerHTML = html;
            });
        // 문제 사이트
        fetch('/api/v1/admin/crawling/problem-sites')
            .then(res => res.json())
            .then(data => {
                if (!data || data.length === 0) {
                    document.getElementById('crawl-problem-sites-container').innerHTML = '<div class="alert alert-success">문제 사이트 없음</div>';
                    return;
                }
                let html = `<h6>문제 사이트(성공률 50% 미만)</h6><div class="table-responsive"><table class="table table-bordered table-sm align-middle"><thead class="table-light"><tr><th>도메인</th><th>성공률</th><th>시도</th><th>실패</th><th>최근 실패</th><th>주요 오류</th></tr></thead><tbody>`;
                for (const s of data) {
                    html += `<tr><td>${s.domain}</td><td>${(s.success_rate*100).toFixed(1)}%</td><td>${s.total_attempts}</td><td>${s.failed_attempts}</td><td>${s.last_failure ? s.last_failure.replace('T',' ').slice(0,19) : ''}</td><td>${Object.keys(s.common_errors||{}).join(', ')}</td></tr>`;
                }
                html += '</tbody></table></div>';
                document.getElementById('crawl-problem-sites-container').innerHTML = html;
            });
        // 최근 시도
        fetch('/api/v1/admin/crawling/recent-attempts?limit=10')
            .then(res => res.json())
            .then(data => {
                if (!data || data.length === 0) {
                    document.getElementById('crawl-recent-attempts-container').innerHTML = '<div class="alert alert-info">최근 시도 내역 없음</div>';
                    return;
                }
                let html = `<h6>최근 시도 내역</h6><div class="table-responsive"><table class="table table-bordered table-sm align-middle"><thead class="table-light"><tr><th>시각</th><th>도메인</th><th>성공</th><th>길이</th><th>오류</th><th>URL</th></tr></thead><tbody>`;
                for (const r of data) {
                    html += `<tr><td>${r.timestamp ? r.timestamp.replace('T',' ').slice(0,19) : ''}</td><td>${r.domain}</td><td>${r.success ? '✅' : '❌'}</td><td>${r.content_length}</td><td>${r.error || ''}</td><td style="max-width:200px;word-break:break-all"><a href="${r.url}" target="_blank">링크</a></td></tr>`;
                }
                html += '</tbody></table></div>';
                document.getElementById('crawl-recent-attempts-container').innerHTML = html;
            });
        // 리포트
        fetch('/api/v1/admin/crawling/report')
            .then(res => res.json())
            .then(data => {
                document.getElementById('crawl-report-container').innerHTML = `<pre style="white-space:pre-wrap;font-size:0.97em;background:#f8f9fa;border:1px solid #eee;padding:1em;">${data.report}</pre>`;
            });
    }

    // API Key 관리 함수
    function loadApiKeys() {
        fetch('/api/v1/admin/api-keys')
            .then(res => res.json())
            .then(data => renderApiKeysTable(data));
    }

    function renderApiKeysTable(keys) {
        const container = document.getElementById('api-keys-table-container');
        if (!keys || keys.length === 0) {
            container.innerHTML = '<div class="alert alert-info">등록된 API Key가 없습니다.</div>';
            return;
        }
        let html = `<div class="table-responsive"><table class="table table-bordered table-sm align-middle"><thead class="table-light"><tr><th>서비스</th><th>Key</th><th>설명</th><th>상태</th><th>관리</th></tr></thead><tbody>`;
        for (const k of keys) {
            const keyShort = k.key.length > 8 ? k.key.slice(0,4) + '****' + k.key.slice(-4) : '****';
            html += `<tr><td>${k.service}</td><td><span style="font-family:monospace;">${keyShort}</span> <button class="btn btn-outline-secondary btn-sm btn-copy" title="복사" onclick="copyApiKey('${k.key}')"><i class="bi bi-clipboard"></i></button></td><td>${k.description||''}</td><td>${k.is_active ? '<span class=\'text-success\'>활성</span>' : '<span class=\'text-danger\'>비활성</span>'}</td><td><button class="btn btn-outline-primary btn-sm me-1" onclick="editApiKey(${k.id},'${k.service}','${k.key.replace(/'/g,"&#39;")}', '${(k.description||'').replace(/'/g,"&#39;")}', ${k.is_active})"><i class="bi bi-pencil"></i></button><button class="btn btn-outline-danger btn-sm" onclick="deleteApiKey(${k.id})"><i class="bi bi-trash"></i></button></td></tr>`;
        }
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function showApiKeyModal(id, service, key, desc, active) {
        document.getElementById('apiKeyForm').reset();
        document.getElementById('apiKeyId').value = id || '';
        document.getElementById('apiKeyService').value = service || '';
        document.getElementById('apiKeyValue').value = key || '';
        document.getElementById('apiKeyDesc').value = desc || '';
        document.getElementById('apiKeyActive').checked = (active === undefined ? true : active);
        document.getElementById('apiKeyModalTitle').textContent = id ? 'API Key 수정' : 'API Key 등록';
        const modal = new bootstrap.Modal(document.getElementById('apiKeyModal'));
        modal.show();
    }

    function submitApiKeyForm() {
        const id = document.getElementById('apiKeyId').value;
        const service = document.getElementById('apiKeyService').value;
        const key = document.getElementById('apiKeyValue').value;
        const desc = document.getElementById('apiKeyDesc').value;
        const is_active = document.getElementById('apiKeyActive').checked;
        if (!service || !key) {
            alert('서비스명과 API Key를 입력하세요.');
            return;
        }
        const payload = { service, key, description: desc, is_active };
        if (id) {
            fetch(`/api/v1/admin/api-keys/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(() => loadApiKeys());
        } else {
            fetch('/api/v1/admin/api-keys', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(() => loadApiKeys());
        }
    }

    function editApiKey(id, service, key, desc, active) {
        showApiKeyModal(id, service, key, desc, active);
    }

    function deleteApiKey(id) {
        if (!confirm('정말로 삭제하시겠습니까?')) return;
        fetch(`/api/v1/admin/api-keys/${id}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(() => loadApiKeys());
    }

    function copyApiKey(key) {
        navigator.clipboard.writeText(key).then(() => {
            alert('API Key가 클립보드에 복사되었습니다.');
        });
    }

    // 키워드 블랙/화이트리스트 관리 함수 (API 연동)
    function showKeywordListModal(type) {
        document.getElementById('keywordListType').value = type;
        document.getElementById('keywordListModalTitle').textContent = (type === 'black' ? '블랙리스트 관리' : '화이트리스트 관리');
        document.getElementById('keywordListInput').value = '';
        loadKeywordListTable(type);
        const modal = new bootstrap.Modal(document.getElementById('keywordListModal'));
        modal.show();
    }
    function loadKeywordListTable(type) {
        fetch(`/api/v1/admin/keywords-list?type=${type}`)
            .then(res => res.json())
            .then(list => {
                let html = `<div class='mb-2'>
                    <button class='btn btn-outline-primary btn-sm me-2' onclick='bulkAddKeywords()'><i class='bi bi-plus'></i> 일괄 추가</button>
                    <button class='btn btn-outline-danger btn-sm' onclick='bulkDeleteKeywords()'><i class='bi bi-trash'></i> 선택 삭제</button>
                </div>`;
                html += `<div class='table-responsive'><table class='table table-bordered table-sm align-middle'><thead class='table-light'><tr><th style='width:40px'><input type='checkbox' id='all-keyword-check' onchange='toggleAllKeywordCheck(this)'></th><th>키워드</th><th>관리</th></tr></thead><tbody>`;
                for (const k of list) {
                    html += `<tr><td><input type='checkbox' class='keyword-check' value='${k.keyword}'></td><td>${k.keyword}</td><td><button class='btn btn-outline-danger btn-sm' onclick='deleteKeyword("${type}", "${k.keyword}")'><i class='bi bi-trash'></i></button></td></tr>`;
                }
                html += '</tbody></table></div>';
                document.getElementById('keywordListTableContainer').innerHTML = html;
            });
    }
    function submitKeywordListForm() {
        const type = document.getElementById('keywordListType').value;
        const input = document.getElementById('keywordListInput').value;
        const keywords = input.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);
        if (!keywords.length) { alert('키워드를 입력하세요.'); return; }
        fetch('/api/v1/admin/keywords-list/bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type, keywords })
        }).then(res => res.json()).then(() => {
            loadKeywordListTable(type);
            document.getElementById('keywordListInput').value = '';
        });
    }
    function deleteKeyword(type, keyword) {
        if (!confirm('정말 삭제하시겠습니까?')) return;
        fetch(`/api/v1/admin/keywords-list?type=${type}&keyword=${encodeURIComponent(keyword)}`, { method: 'DELETE' })
            .then(res => res.json()).then(() => loadKeywordListTable(type));
    }
    function bulkAddKeywords() {
        document.getElementById('keywordListInput').focus();
    }
    function bulkDeleteKeywords() {
        const type = document.getElementById('keywordListType').value;
        const checked = Array.from(document.querySelectorAll('.keyword-check:checked')).map(cb => cb.value);
        if (!checked.length) { alert('삭제할 키워드를 선택하세요.'); return; }
        if (!confirm('정말 선택한 키워드를 삭제하시겠습니까?')) return;
        fetch(`/api/v1/admin/keywords-list/bulk?type=${type}&keywords=${checked.join(',')}`, { method: 'DELETE' })
            .then(res => res.json()).then(() => loadKeywordListTable(type));
    }
    function toggleAllKeywordCheck(box) {
        document.querySelectorAll('.keyword-check').forEach(cb => cb.checked = box.checked);
    }

    // 포스트 일괄 관리 함수 (API 연동)
    let postsBulkList = [];
    function loadPostsBulkTable() {
        fetch('/api/v1/blog-generator/posts?skip=0&limit=1000')
            .then(res => res.json())
            .then(list => {
                postsBulkList = list;
                renderPostsBulkTable(list);
            });
    }
    function renderPostsBulkTable(list) {
        let html = `<div class='mb-2'>
            <input type='text' class='form-control form-control-sm d-inline-block' style='width:200px' id='postsBulkSearch' placeholder='제목/키워드 검색' oninput='searchPostsBulk()'>
            <button class='btn btn-outline-secondary btn-sm ms-2' onclick='selectAllPostsBulk(true)'>전체선택</button>
            <button class='btn btn-outline-secondary btn-sm ms-1' onclick='selectAllPostsBulk(false)'>전체해제</button>
        </div>`;
        html += `<div class='table-responsive'><table class='table table-bordered table-sm align-middle'><thead class='table-light'><tr><th style='width:40px'><input type='checkbox' id='all-posts-bulk-check' onchange='toggleAllPostsBulkCheck(this)'></th><th>ID</th><th>제목</th><th>키워드</th><th>생성일</th></tr></thead><tbody>`;
        for (const p of list) {
            html += `<tr><td><input type='checkbox' class='posts-bulk-check' value='${p.id}'></td><td>${p.id}</td><td>${p.title}</td><td>${p.keywords||''}</td><td>${p.created_at ? p.created_at.replace('T',' ').slice(0,19) : ''}</td></tr>`;
        }
        html += '</tbody></table></div>';
        document.getElementById('posts-bulk-table-container').innerHTML = html;
    }
    function searchPostsBulk() {
        const q = document.getElementById('postsBulkSearch').value.trim();
        if (!q) { renderPostsBulkTable(postsBulkList); return; }
        const filtered = postsBulkList.filter(p => (p.title && p.title.includes(q)) || (p.keywords && p.keywords.includes(q)));
        renderPostsBulkTable(filtered);
    }
    function selectAllPostsBulk(flag) {
        document.querySelectorAll('.posts-bulk-check').forEach(cb => cb.checked = flag);
    }
    function toggleAllPostsBulkCheck(box) {
        document.querySelectorAll('.posts-bulk-check').forEach(cb => cb.checked = box.checked);
    }
    function getSelectedPostIds() {
        return Array.from(document.querySelectorAll('.posts-bulk-check:checked')).map(cb => parseInt(cb.value));
    }
    function bulkDeletePosts() {
        const ids = getSelectedPostIds();
        if (!ids.length) { alert('삭제할 포스트를 선택하세요.'); return; }
        if (!confirm('정말 선택한 포스트를 삭제하시겠습니까?')) return;
        fetch('/api/v1/admin/posts/bulk-delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ post_ids: ids })
        }).then(res => res.json()).then(() => loadPostsBulkTable());
    }
    function exportPosts() {
        const ids = getSelectedPostIds();
        let url = '/api/v1/admin/posts/export';
        if (ids.length) url += '?ids=' + ids.join(',');
        window.open(url, '_blank');
    }
    function showImportModal() {
        const modal = new bootstrap.Modal(document.getElementById('importModal'));
        modal.show();
    }
    function importPosts() {
        const input = document.getElementById('importFileInput');
        if (!input.files.length) { alert('파일을 선택하세요.'); return; }
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                fetch('/api/v1/admin/posts/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(res => res.json()).then(() => {
                    alert('복원 완료!');
                    loadPostsBulkTable();
                    bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
                });
            } catch (err) {
                alert('유효한 JSON 파일이 아닙니다.');
            }
        };
        reader.readAsText(file);
    }
    function exportPostsXlsx() {
        const ids = getSelectedPostIds();
        let url = '/api/v1/admin/posts/export-xlsx';
        if (ids.length) url += '?ids=' + ids.join(',');
        window.open(url, '_blank');
    }
    // 탭 진입 시 데이터 로드
    if (document.getElementById('tab-keywords')) {
        document.getElementById('tab-keywords').addEventListener('shown.bs.tab', function() {
            loadKeywordListTable('black'); // 진입 시 블랙리스트 먼저 로드
        });
    }
    if (document.getElementById('tab-posts')) {
        document.getElementById('tab-posts').addEventListener('shown.bs.tab', function() {
            loadPostsBulkTable();
        });
    }
    // 워드클라우드/트렌드/검색 함수 뼈대 추가
    function renderKeywordWordcloud(wordcloudData) {
        const container = document.getElementById('keyword-wordcloud');
        container.innerHTML = '';
        if (!wordcloudData || wordcloudData.length === 0) {
            container.innerHTML = '<div class="text-muted text-center pt-5">데이터 없음</div>';
            return;
        }
        d3.select('#keyword-wordcloud').selectAll('*').remove();
        d3.layout.cloud().size([400, 200])
            .words(wordcloudData.map(d => Object.assign({}, d)))
            .padding(3)
            .rotate(() => ~~(Math.random() * 2) * 90)
            .font('IBM Plex Sans KR')
            .fontSize(d => d.size)
            .on('end', draw)
            .start();
        function draw(words) {
            d3.select('#keyword-wordcloud')
                .append('svg')
                .attr('width', 400)
                .attr('height', 200)
                .append('g')
                .attr('transform', 'translate(200,100)')
                .selectAll('text')
                .data(words)
                .enter().append('text')
                .style('font-size', d => d.size + 'px')
                .style('font-family', 'IBM Plex Sans KR')
                .style('fill', (d,i) => d3.schemeCategory10[i%d3.schemeCategory10.length])
                .attr('text-anchor', 'middle')
                .attr('transform', d => `translate(${d.x},${d.y})rotate(${d.rotate})`)
                .text(d => d.text);
        }
    }
    function renderKeywordTrendChart(labels, counts) {
        const ctx = document.getElementById('keyword-trend-chart').getContext('2d');
        if (window.keywordTrendChartInstance) {
            window.keywordTrendChartInstance.destroy();
        }
        if (!labels || !counts || counts.length === 0) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = '16px IBM Plex Sans KR, sans-serif';
            ctx.fillStyle = '#bbb';
            ctx.textAlign = 'center';
            ctx.fillText('데이터 없음', ctx.canvas.width/2, ctx.canvas.height/2);
            return;
        }
        window.keywordTrendChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '고유 개수',
                    data: counts,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }
    function filterKeywordsTable() {
        const q = document.getElementById('keywordSearchInput').value.trim().toLowerCase();
        const rows = document.querySelectorAll('#keywords-table-container tbody tr');
        rows.forEach(row => {
            // 키워드, 고유 개수(세 번째 컬럼)에서만 검색
            const keywordCell = row.children[1];
            const countCell = row.querySelectorAll('td.col-multiline')[0];
            const keywordVal = keywordCell ? keywordCell.textContent.toLowerCase() : '';
            const countVal = countCell ? countCell.textContent.trim() : '';
            if (!q || keywordVal.includes(q) || countVal === q) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    function renderKeywordSummary(stats) {
        // stats: [{keyword, count, type, ...}]
        document.getElementById('sum-total').textContent = stats && stats.length ? stats.length : 0;
        document.getElementById('sum-black').textContent = stats ? stats.filter(s=>s.type==='black').length : 0;
        document.getElementById('sum-white').textContent = stats ? stats.filter(s=>s.type==='white').length : 0;
        document.getElementById('sum-new').textContent = stats ? stats.filter(s=>s.is_new).length : 0;
        document.getElementById('sum-deleted').textContent = stats ? stats.filter(s=>s.is_deleted).length : 0;
    }
    function renderAIKeywordFeatures(stats) {
        // 추천 키워드
        fetch('/api/v1/admin/keywords-recommend')
            .then(res => res.json())
            .then(list => {
                document.getElementById('ai-recommend-keywords').textContent = list && list.length ? list.join(', ') : '-';
                document.getElementById('recommendModalBody').innerHTML = `<div class='mb-2 text-muted small'>추천 방식: 최근 포스트+등장 빈도+AI 추천 혼합(향후 GPT/Embedding 연동 가능)</div>` + (list && list.length ? list.map(k=>`<span class='badge bg-primary me-1'>${k}</span>`).join('') : '추천 키워드 없음');
            });
        // 유사/중복 키워드
        const sim = parseFloat(document.getElementById('simThreshold')?.value || '0.8');
        fetch('/api/v1/admin/keywords-duplicates')
            .then(res => res.json())
            .then(list => {
                const filtered = list.filter(d=>d.similarity>=sim);
                document.getElementById('ai-dup-keywords').textContent = filtered && filtered.length ? filtered.slice(0,3).map(d=>`${d.a} / ${d.b}`).join(', ') : '-';
                document.getElementById('dupModalBody').innerHTML = `<div class='mb-2 text-muted small'>유사도 기준: Levenshtein, 선택값 이상(0~1, 높을수록 엄격)</div>` + (filtered && filtered.length ? filtered.map(d=>`<div class='mb-2'><span class='badge bg-danger'>${d.a}</span> <span class='badge bg-danger'>${d.b}</span> <span class='text-muted small'>(${d.similarity})</span></div>`).join('') : '유사/중복 키워드 없음');
            });
        // 동의어/번역어
        fetch('/api/v1/admin/keywords-synonyms')
            .then(res => res.json())
            .then(data => {
                const synList = Object.entries(data||{});
                document.getElementById('ai-syn-keywords').textContent = synList.length ? synList.slice(0,3).map(([k,v])=>`${k}→${v.join('/')}`).join(', ') : '-';
                // 동의어 관리 모달 내용
                let html = `<div class='mb-2 text-muted small'>동의어/번역어는 수동 추가/삭제, 향후 AI 자동 추천/번역 연동 가능</div>`;
                html += `<form id='synForm'><div class='mb-2 d-flex'><input type='text' class='form-control form-control-sm me-2' id='synKeywordInput' placeholder='키워드'><input type='text' class='form-control form-control-sm me-2' id='synValueInput' placeholder='동의어'><button type='button' class='btn btn-success btn-sm' onclick='addSynonym()'>추가</button></div></form>`;
                if(synList.length) {
                    html += '<ul class="list-group">'+synList.map(([k,arr])=>arr.map(v=>`<li class='list-group-item d-flex justify-content-between align-items-center py-1'><span><b>${k}</b> → ${v}</span><button class='btn btn-outline-danger btn-sm btn-syn-del' data-k='${k}' data-v='${v}'>삭제</button></li>`).join('')).join('')+'</ul>';
                } else {
                    html += '<div class="text-muted">등록된 동의어가 없습니다.</div>';
                }
                document.getElementById('synModalBody').innerHTML = html;
                setTimeout(()=>{
                    document.querySelectorAll('.btn-syn-del').forEach(btn=>{
                        btn.onclick = function(){ deleteSynonym(btn.dataset.k, btn.dataset.v); };
                    });
                }, 100);
            });
    }
    function showRecommendModal() {
        new bootstrap.Modal(document.getElementById('recommendModal')).show();
    }
    function showDupModal() {
        new bootstrap.Modal(document.getElementById('dupModal')).show();
    }
    function showSynModal() {
        new bootstrap.Modal(document.getElementById('synModal')).show();
    }
    function addSynonym() {
        const k = document.getElementById('synKeywordInput').value.trim();
        const v = document.getElementById('synValueInput').value.trim();
        if(!k||!v) { alert('키워드와 동의어를 입력하세요.'); return; }
        fetch('/api/v1/admin/keywords-synonyms', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({keyword:k, synonym:v})
        }).then(()=>{ showSynModal(); renderAIKeywordFeatures([]); });
    }
    function deleteSynonym(k, v) {
        fetch(`/api/v1/admin/keywords-synonyms?keyword=${encodeURIComponent(k)}&synonym=${encodeURIComponent(v)}`, {method:'DELETE'})
            .then(()=>{ showSynModal(); renderAIKeywordFeatures([]); });
    }
    // AI RULE 적용 폼 안내 메시지 처리
    document.addEventListener('DOMContentLoaded', function() {
        const aiRuleForm = document.getElementById('ai-rule-form');
        if (aiRuleForm) {
            aiRuleForm.addEventListener('submit', function(e) {
                e.preventDefault(); // 기본 submit 막기
                // 안내 팝업
                alert('선택한 RULE/가이드라인은 실제 블로그 생성 시에만 적용됩니다.\n실제 저장/적용은 필요하지 않습니다.');
                // 3초간 안내 문구 표시
                let msg = document.getElementById('ai-rule-applied-msg');
                if (!msg) {
                    msg = document.createElement('div');
                    msg.id = 'ai-rule-applied-msg';
                    msg.className = 'alert alert-success mt-2';
                    msg.innerText = '실제 저장/적용 되었습니다';
                    aiRuleForm.parentNode.insertBefore(msg, aiRuleForm.nextSibling);
                } else {
                    msg.style.display = 'block';
                }
                setTimeout(() => { msg.style.display = 'none'; }, 3000);
            });
        }
    });
    // 오늘의 기능 업데이트 날짜 및 내용 표시
    (function(){
        fetch('/api/v1/feature-updates/today')
            .then(res => res.json())
            .then(data => {
                const el = document.getElementById('today-feature-update-text');
                if (el) {
                    if (data.update) {
                        el.innerHTML = `<span style='font-weight:bold;'>오늘(${data.date})의 주요 기능 업데이트 :</span> <span style='font-weight:400;'>${data.update}</span>`;
                    } else {
                        el.innerHTML = `<span style='font-weight:bold;'>오늘(${data.date})의 주요 기능 업데이트 :</span> <span style='font-weight:400;color:#bbb;'>등록된 내역이 없습니다.</span>`;
                    }
                }
            });
    })();
    // 기능 업데이트 이력(히스토리) 불러오기
    function loadFeatureUpdatesHistory() {
        const container = document.getElementById('feature-updates-history-list');
        container.innerHTML = '불러오는 중...';
        fetch('/api/v1/feature-updates/history')
            .then(res => res.json())
            .then(list => {
                if (!list || list.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">등록된 기능 업데이트 이력이 없습니다.</div>';
                    return;
                }
                let html = '<ul class="list-group">';
                list.forEach(item => {
                    html += `<li class="list-group-item">
                        <span class="fw-bold">${item.date}</span><br>
                        <span style="white-space:pre-line;">${item.content}</span>
                    </li>`;
                });
                html += '</ul>';
                container.innerHTML = html;
            })
            .catch(() => {
                container.innerHTML = '<div class="alert alert-danger">이력 불러오기 실패</div>';
            });
    }
    // 탭 진입 시 자동 로드
    document.getElementById('tab-feature-updates-history').addEventListener('shown.bs.tab', loadFeatureUpdatesHistory);
    </script>
</body>
</html> 